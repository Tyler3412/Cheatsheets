Navigation: [[Binary Exploitation]]

---
# Introduction
Assembly language (`asm`) is the direct mapping from CPU instruction to a human readable implementation. It can be used in 32 bit (x86) or 64 bit (x64). Assembly uses registers, direct memory references, and features a stack as well as function calls (and calling conventions). Each of these will be covered below.
# Table of Contents
1. Instructions
2. Registers
3. Stack Layout
4. Function Calling Conventions
# Instructions

| **Category**          | **Instruction** | **Syntax**            | **Description**                                                                |
| --------------------- | --------------- | --------------------- | ------------------------------------------------------------------------------ |
| **Data Movement**     | `MOV`           | `MOV dest, src`       | Copies data from the source (`src`) to the destination (`dest`).               |
|                       | `MOVSX`         | `MOVSX dest, src`     | Moves data with sign-extension from a smaller to a larger size.                |
|                       | `MOVZX`         | `MOVZX dest, src`     | Moves data with zero-extension from a smaller to a larger size.                |
|                       | `XCHG`          | `XCHG dest, src`      | Exchanges values between `dest` and `src`.                                     |
|                       | `LAHF`          | `LAHF`                | Loads the lower byte of the flags register into `AH`.                          |
|                       | `SAHF`          | `SAHF`                | Stores `AH` into the lower byte of the flags register.                         |
|                       | `XLAT`          | `XLAT`                | Translates a byte using a lookup table addressed by `AL` and `BX`.             |
| **Arithmetic**        | `ADD`           | `ADD dest, src`       | Adds the value of `src` to `dest` and stores the result in `dest`.             |
|                       | `ADC`           | `ADC dest, src`       | Adds `src` and the carry flag to `dest`.                                       |
|                       | `SUB`           | `SUB dest, src`       | Subtracts the value of `src` from `dest` and stores the result in `dest`.      |
|                       | `SBB`           | `SBB dest, src`       | Subtracts `src` and the carry flag from `dest`.                                |
|                       | `MUL`           | `MUL src`             | Multiplies `src` by the value in the accumulator (`EAX`/`RAX`).                |
|                       | `IMUL`          | `IMUL dest, src, imm` | Performs signed multiplication. Variants allow two or three operands.          |
|                       | `DIV`           | `DIV src`             | Divides `EAX`/`RAX` by `src`, storing the quotient and remainder.              |
|                       | `IDIV`          | `IDIV src`            | Performs signed division.                                                      |
|                       | `NEG`           | `NEG dest`            | Negates the value in `dest` (two's complement).                                |
|                       | `INC`           | `INC dest`            | Increments the value in `dest` by 1.                                           |
|                       | `DEC`           | `DEC dest`            | Decrements the value in `dest` by 1.                                           |
| **Logic**             | `AND`           | `AND dest, src`       | Performs a bitwise AND between `src` and `dest`, storing the result in `dest`. |
|                       | `OR`            | `OR dest, src`        | Performs a bitwise OR between `src` and `dest`, storing the result in `dest`.  |
|                       | `XOR`           | `XOR dest, src`       | Performs a bitwise XOR between `src` and `dest`, storing the result in `dest`. |
|                       | `NOT`           | `NOT dest`            | Performs a bitwise NOT on `dest`.                                              |
|                       | `TEST`          | `TEST dest, src`      | Performs a bitwise AND without storing the result, updating CPU flags.         |
|                       | `SHL`           | `SHL dest, count`     | Shifts the bits in `dest` left by `count` places (logical shift).              |
|                       | `SHR`           | `SHR dest, count`     | Shifts the bits in `dest` right by `count` places (logical shift).             |
|                       | `SAR`           | `SAR dest, count`     | Shifts the bits in `dest` right by `count` places (arithmetic shift).          |
|                       | `ROL`           | `ROL dest, count`     | Rotates the bits in `dest` left by `count` places.                             |
|                       | `ROR`           | `ROR dest, count`     | Rotates the bits in `dest` right by `count` places.                            |
| **Control Flow**      | `JMP`           | `JMP label`           | Unconditionally jumps to the specified `label`.                                |
|                       | `JE/JZ`         | `JE label`            | Jumps to `label` if the zero flag (ZF) is set (equal/zero condition).          |
|                       | `JNE/JNZ`       | `JNE label`           | Jumps to `label` if the zero flag (ZF) is clear (not equal/nonzero condition). |
|                       | `JG/JNLE`       | `JG label`            | Jumps if greater (ZF=0 and SF=OF).                                             |
|                       | `JL/JNGE`       | `JL label`            | Jumps if less (SFâ‰ OF).                                                         |
|                       | `CALL`          | `CALL label`          | Calls a subroutine at `label`, saving the return address on the stack.         |
|                       | `RET`           | `RET`                 | Returns from a subroutine, popping the return address off the stack.           |
| **Stack Operations**  | `PUSH`          | `PUSH src`            | Pushes `src` onto the stack.                                                   |
|                       | `POP`           | `POP dest`            | Pops the top value from the stack into `dest`.                                 |
|                       | `PUSHF`         | `PUSHF`               | Pushes the flags register onto the stack.                                      |
|                       | `POPF`          | `POPF`                | Pops the top value of the stack into the flags register.                       |
| **System Operations** | `INT`           | `INT number`          | Triggers a software interrupt, invoking an interrupt handler.                  |
|                       | `HLT`           | `HLT`                 | Halts the CPU until the next external interrupt is received.                   |
|                       | `NOP`           | `NOP`                 | Does nothing (no operation); used for padding or timing adjustments.           |
|                       | `LEA`           | `LEA dest, [addr]`    | Loads the effective address of `addr` into `dest`.                             |
| **String Operations** | `REP MOVSB`     | `REP MOVSB`           | Moves bytes from one memory location to another repeatedly.                    |
|                       | `REP STOSB`     | `REP STOSB`           | Repeatedly stores a byte value in memory.                                      |
|                       | `CMPSB`         | `CMPSB`               | Compares bytes in memory and updates flags.                                    |
|                       | `SCASB`         | `SCASB`               | Scans memory for a specified byte value.                                       |
# Registers and Variables

| **Register** | **Size** | **Purpose**                                                                                     |
|--------------|----------|-------------------------------------------------------------------------------------------------|
| **General-Purpose Registers**                                                                                             |
| `EAX/RAX`    | 32/64-bit| Accumulator: Used for arithmetic operations, I/O, and function return values.                   |
| `EBX/RBX`    | 32/64-bit| Base Register: General-purpose register often used to hold data.                                |
| `ECX/RCX`    | 32/64-bit| Counter: Used for loops and shift operations.                                                  |
| `EDX/RDX`    | 32/64-bit| Data Register: Used in I/O operations and for high-order bits in multiplication/division.       |
| `ESI/RSI`    | 32/64-bit| Source Index: Used as a source pointer for string operations.                                   |
| `EDI/RDI`    | 32/64-bit| Destination Index: Used as a destination pointer for string operations.                         |
| `EBP/RBP`    | 32/64-bit| Base Pointer: Points to the base of the stack frame. Often used to access function arguments.    |
| `ESP/RSP`    | 32/64-bit| Stack Pointer: Points to the top of the stack.                                                  |
| `R8`-`R15`   | 64-bit   | Additional general-purpose registers in x64.                                                   |
| **Segment Registers**                                                                                                     |
| `CS`         | 16-bit   | Code Segment: Points to the segment containing the currently executing code.                    |
| `DS`         | 16-bit   | Data Segment: Points to the segment containing data.                                            |
| `SS`         | 16-bit   | Stack Segment: Points to the segment containing the stack.                                      |
| `ES`         | 16-bit   | Extra Segment: Used for additional data storage.                                                |
| `FS`         | 16-bit   | Extra Segment: Often used for thread-specific data.                                             |
| `GS`         | 16-bit   | Extra Segment: Also used for thread-specific data, especially in modern OS environments.        |
| **Instruction Pointer**                                                                                                   |
| `EIP/RIP`    | 32/64-bit| Instruction Pointer: Points to the next instruction to execute.                                 |
| **Flags Register**                                                                                                        |
| `EFLAGS/RFLAGS` | 32/64-bit | Flags: Holds condition codes and control bits for CPU status (e.g., zero flag, carry flag).  |
| **Floating-Point and SIMD Registers**                                                                                    |
| `ST(0)`-`ST(7)` | 80-bit | Floating-point stack registers for legacy x87 operations.                                      |
| `XMM0`-`XMM15` | 128-bit | SIMD registers for floating-point and integer operations (available in SSE/SSE2 instructions). |
| `YMM0`-`YMM15` | 256-bit | Extended SIMD registers for AVX instructions.                                                 |
| `ZMM0`-`ZMM31` | 512-bit | SIMD registers for AVX-512 instructions.                                                       |
| **Special Registers**                                                                                                     |
| `CR0`-`CR4`   | 32/64-bit| Control Registers: Used for controlling CPU modes and features (e.g., enabling paging).         |
| `DR0`-`DR7`   | 32/64-bit| Debug Registers: Used for hardware breakpoints during debugging.                               |
| `IDTR`        | 48-bit   | Interrupt Descriptor Table Register: Points to the interrupt descriptor table.                 |
| `GDTR`        | 48-bit   | Global Descriptor Table Register: Points to the global descriptor table.                       |
| `TR`          | 16-bit   | Task Register: Points to the task state segment for task management.                           |
| `MSR`         | Varies   | Model-Specific Registers: Used for configuring processor-specific features.                    |

| **64-bit** | **32-bit** | **16-bit** | **8-bit High** | **8-bit Low** |
|------------|------------|------------|----------------|---------------|
| `RAX`      | `EAX`      | `AX`       | `AH`           | `AL`          |
| `RBX`      | `EBX`      | `BX`       | `BH`           | `BL`          |
| `RCX`      | `ECX`      | `CX`       | `CH`           | `CL`          |
| `RDX`      | `EDX`      | `DX`       | `DH`           | `DL`          |
| `RSI`      | `ESI`      | `SI`       | -              | -             |
| `RDI`      | `EDI`      | `DI`       | -              | -             |
| `RBP`      | `EBP`      | `BP`       | -              | -             |
| `RSP`      | `ESP`      | `SP`       | -              | -             |
| `R8`       | `R8D`      | `R8W`      | -              | `R8B`         |
| `R9`       | `R9D`      | `R9W`      | -              | `R9B`         |
| `R10`      | `R10D`     | `R10W`     | -              | `R10B`        |
| `R11`      | `R11D`     | `R11W`     | -              | `R11B`        |
| `R12`      | `R12D`     | `R12W`     | -              | `R12B`        |
| `R13`      | `R13D`     | `R13W`     | -              | `R13B`        |
| `R14`      | `R14D`     | `R14W`     | -              | `R14B`        |
| `R15`      | `R15D`     | `R15W`     | -              | `R15B`        |
# Stack Layout
Next we have the stack. This differs in x86 to x64:

Here's the x86 stack:
![[x86_Stack.png]]

x64 Stack:
![[x64_stack.png]]
# Function Calling Conventions

| **Platform** | **Calling Convention** | **Description**                                                                                     |
|--------------|-------------------------|-----------------------------------------------------------------------------------------------------|
| **x86**      | `cdecl`                | Arguments pushed onto the stack in reverse order (right to left). Caller cleans up the stack.       |
|              | `stdcall`              | Arguments pushed onto the stack in reverse order. Callee cleans up the stack.                      |
|              | `fastcall`             | First two arguments passed in registers (`ECX`, `EDX`), remaining on the stack.                    |
|              | `thiscall`             | Used for C++ member functions. The `this` pointer is passed in `ECX`. Other arguments follow `stdcall`.|
| **x64**      | System V (Linux/macOS) | First six arguments passed in registers (`RDI`, `RSI`, `RDX`, `RCX`, `R8`, `R9`). Remaining on the stack.|
|              | Microsoft x64          | First four arguments passed in registers (`RCX`, `RDX`, `R8`, `R9`). Remaining on the stack.        |

Differences between architectures:

| **Feature**                         | **x86: cdecl/stdcall**                 | **x64: System V**                      | **x64: Microsoft**                    |
| ----------------------------------- | -------------------------------------- | -------------------------------------- | ------------------------------------- |
| **Register Argument Passing**       | None                                   | First 6 arguments in registers:        | First 4 arguments in registers:       |
|                                     |                                        | `RDI`, `RSI`, `RDX`, `RCX`, `R8`, `R9` | `RCX`, `RDX`, `R8`, `R9`              |
| **Stack Argument Order**            | Reverse order (right to left)          | Reverse order (right to left)          | Reverse order (right to left)         |
| **Stack Cleanup**                   | Caller (`cdecl`) or callee (`stdcall`) | Caller                                 | Caller                                |
| **Stack Alignment**                 | 4-byte aligned                         | 16-byte aligned                        | 16-byte aligned                       |
| **`this` Pointer (C++)**            | Passed in `ECX` for `thiscall`         | Passed as the first argument in `RDI`  | Passed as the first argument in `RCX` |
| **Floating-Point Argument Passing** | Stack                                  | SSE registers (`XMM0`-`XMM7`)          | SSE registers (`XMM0`-`XMM3`)         |
| **Return Values**                   | Stored in `EAX`                        | Stored in `RAX`                        | Stored in `RAX`                       |
| **Variadic Functions**              | Arguments passed on the stack          | Additional arguments on the stack      | Additional arguments on the stack     |

Function prologues and epilogues:

| **Step**           | **x86 (32-bit)**                            | **x64 (64-bit)**                                  |
|---------------------|---------------------------------------------|--------------------------------------------------|
| **Prologue**        |                                             |                                                  |
| **Set up the stack**| `PUSH EBP`                                 | `PUSH RBP`                                       |
|                     | Saves the old base pointer on the stack.   | Saves the old base pointer on the stack.         |
|                     | `MOV EBP, ESP`                             | `MOV RBP, RSP`                                   |
|                     | Sets up the base pointer for the new frame.| Sets up the base pointer for the new frame.      |
|                     | `SUB ESP, N`                               | `SUB RSP, N`                                     |
|                     | Allocates space for local variables.       | Allocates space for local variables.             |
| **Callee-saved regs**| `PUSH EBX`, `PUSH ESI`, etc.               | `PUSH RBX`, `PUSH R12`-`PUSH R15` as needed.     |
|                     | Saves callee-saved registers (if modified).| Saves callee-saved registers (if modified).      |
| **Optional alignment**| -                                        | `AND RSP, -16` (align stack to 16 bytes).        |
| **Optional setup**  | `LEA EAX, [ESP + 4]` (varargs)             | `MOV RDX, RSP` (varargs setup).                  |
| **Epilogue**        |                                             |                                                  |
| **Restore registers**| `POP EBX`, `POP ESI`, etc.                | `POP RBX`, `POP R12`-`POP R15` as needed.        |
|                     | Restores callee-saved registers.           | Restores callee-saved registers.                 |
| **Restore stack**   | `MOV ESP, EBP`                             | `MOV RSP, RBP`                                   |
|                     | Restores the stack pointer.                | Restores the stack pointer.                      |
| **Return address**  | `POP EBP`                                  | `POP RBP`                                        |
|                     | Restores the old base pointer.             | Restores the old base pointer.                   |
|                     | `RET`                                      | `RET`                                            |
|                     | Returns to the caller.                     | Returns to the caller.                           |

# ELF Files

| **Component**                      | **Description**                                                   | **Details**                                                                                     |
| ---------------------------------- | ----------------------------------------------------------------- | ----------------------------------------------------------------------------------------------- |
| **ELF Header**                     | Metadata about the ELF file.                                      | Magic number, file type, architecture, entry point, and offsets to program and section headers. |
| **Program Header Table**           | Describes segments that are mapped into memory during execution.  | Includes loadable segments (`.text`, `.data`), interpreter paths, and memory permissions.       |
| **Section Header Table**           | Describes sections used for linking, debugging, and execution.    | Includes `.text`, `.data`, `.bss`, `.symtab`, `.strtab`, and `.rel` sections.                   |
| **.text**                          | Contains executable code.                                         | Machine instructions executed by the CPU.                                                       |
| **.data**                          | Contains initialized global and static variables.                 | Allocated and initialized in memory at runtime.                                                 |
| **.bss**                           | Contains uninitialized global and static variables.               | Allocated in memory but not stored in the ELF file.                                             |
| **.rodata**                        | Contains read-only data (e.g., string literals, constants).       | Stored in a read-only memory region.                                                            |
| **.symtab**                        | Static symbol table for linking.                                  | Contains symbols (e.g., function and variable names) and their locations.                       |
| **.strtab**                        | String table containing symbol names.                             | Used to resolve symbol names in the `.symtab` and `.dynsym` sections.                           |
| **.rel.text / .rela.text**         | Relocation entries for the `.text` section.                       | Contains information for adjusting addresses during linking or loading.                         |
| **Dynamic Section (.dynamic)**     | Metadata for the dynamic linker.                                  | Includes shared library dependencies and GOT/PLT information.                                   |
| **Procedure Linkage Table (PLT)**  | Provides stubs for calling dynamically linked functions.          | Works with GOT for lazy symbol resolution.                                                      |
| **Global Offset Table (GOT)**      | Contains addresses of dynamically linked variables and functions. | Updated by the dynamic linker for position-independent code.                                    |
| **Dynamic Symbol Table (.dynsym)** | Symbol table for dynamic linking.                                 | Contains only symbols needed for dynamic linking.                                               |
| **Debugging Sections**             | Optional sections for source-level debugging.                     | `.debug_info`, `.debug_line`, `.debug_frame`, and others.                                       |
| **Relocation Entries**             | Adjust addresses for linking or execution.                        | Includes relocation types (`R_X86_64_PC32`, `R_X86_64_PLT32`) and associated symbols.           |
| **Interpreter Section (.interp)**  | Specifies the dynamic linker to be used.                          | Contains a path to the dynamic loader (e.g., `/lib64/ld-linux-x86-64.so.2`).                    |
| **Note Section (.note)**           | Contains annotations or metadata.                                 | Often used for OS-specific information or build identification.                                 |
| **Core Dump Sections**             | Specific to core dump files for debugging crashed processes.      | Contains process state, memory contents, and register values.                                   |

Further reading:
https://eli.thegreenplace.net/2011/08/25/load-time-relocation-of-shared-libraries/

---
Navigation: [[Binary Exploitation]]