Navigation: [[Pentesting]]

---
# Table of Contents
1. Overview
2. Tools of the Trade
3. Methodology
4. Enumeration
	1. Passive recon
	2. Active recon
5. Initial Foothold
	1. LLMNR/NBT-NS Poisoning
	2. Password Spraying

Useful Stuff:

# Active Directory Overview
Here's a [video guide](https://www.youtube.com/watch?v=4qC7H-y7oKI) on active directory that should help to fill in some basic knowledge.

# Tools of the Trade
This entire table is taken from HTB Academy:

| Tool                                                                                                                                          | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| --------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [PowerView](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1)/[SharpView](https://github.com/dmchell/SharpView) | A PowerShell tool and a .NET port of the same used to gain situational awareness in AD. These tools can be used as replacements for various Windows `net*` commands and more. PowerView and SharpView can help us gather much of the data that BloodHound does, but it requires more work to make meaningful relationships among all of the data points. These tools are great for checking what additional access we may have with a new set of credentials, targeting specific users or computers, or finding some "quick wins" such as users that can be attacked via Kerberoasting or ASREPRoasting. |
| [BloodHound](https://github.com/BloodHoundAD/BloodHound)                                                                                      | Used to visually map out AD relationships and help plan attack paths that may otherwise go unnoticed. Uses the [SharpHound](https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors) PowerShell or C# ingestor to gather data to later be imported into the BloodHound JavaScript (Electron) application with a [Neo4j](https://neo4j.com/) database for graphical analysis of the AD environment.                                                                                                                                                                                             |
| [SharpHound](https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors)                                                               | The C# data collector to gather information from Active Directory about varying AD objects such as users, groups, computers, ACLs, GPOs, user and computer attributes, user sessions, and more. The tool produces JSON files which can then be ingested into the BloodHound GUI tool for analysis.                                                                                                                                                                                                                                                                                                       |
| [BloodHound.py](https://github.com/fox-it/BloodHound.py)                                                                                      | A Python-based BloodHound ingestor based on the [Impacket toolkit](https://github.com/CoreSecurity/impacket/). It supports most BloodHound collection methods and can be run from a non-domain joined attack host. The output can be ingested into the BloodHound GUI for analysis.                                                                                                                                                                                                                                                                                                                      |
| [Kerbrute](https://github.com/ropnop/kerbrute)                                                                                                | A tool written in Go that uses Kerberos Pre-Authentication to enumerate Active Directory accounts, perform password spraying, and brute-forcing.                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| [Impacket toolkit](https://github.com/SecureAuthCorp/impacket)                                                                                | A collection of tools written in Python for interacting with network protocols. The suite of tools contains various scripts for enumerating and attacking Active Directory.                                                                                                                                                                                                                                                                                                                                                                                                                              |
| [Responder](https://github.com/lgandx/Responder)                                                                                              | Responder is a purpose-built tool to poison LLMNR, NBT-NS, and MDNS, with many different functions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| [Inveigh.ps1](https://github.com/Kevin-Robertson/Inveigh/blob/master/Inveigh.ps1)                                                             | Similar to Responder, a PowerShell tool for performing various network spoofing and poisoning attacks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| [C# Inveigh (InveighZero)](https://github.com/Kevin-Robertson/Inveigh/tree/master/Inveigh)                                                    | The C# version of Inveigh with a semi-interactive console for interacting with captured data such as username and password hashes.                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| [rpcinfo](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/rpcinfo)                                           | The rpcinfo utility is used to query the status of an RPC program or enumerate the list of available RPC services on a remote host. The "-p" option is used to specify the target host. For example the command "rpcinfo -p 10.0.0.1" will return a list of all the RPC services available on the remote host, along with their program number, version number, and protocol. Note that this command must be run with sufficient privileges.                                                                                                                                                             |
| [rpcclient](https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html)                                                               | A part of the Samba suite on Linux distributions that can be used to perform a variety of Active Directory enumeration tasks via the remote RPC service.                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| [CrackMapExec (CME)](https://github.com/byt3bl33d3r/CrackMapExec)                                                                             | CME is an enumeration, attack, and post-exploitation toolkit which can help us greatly in enumeration and performing attacks with the data we gather. CME attempts to "live off the land" and abuse built-in AD features and protocols like SMB, WMI, WinRM, and MSSQL.                                                                                                                                                                                                                                                                                                                                  |
| [Rubeus](https://github.com/GhostPack/Rubeus)                                                                                                 | Rubeus is a C# tool built for Kerberos Abuse.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| [GetUserSPNs.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetUserSPNs.py)                                              | Another Impacket module geared towards finding Service Principal names tied to normal users.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| [Hashcat](https://hashcat.net/hashcat/)                                                                                                       | A great hash cracking and password recovery tool.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| [enum4linux](https://github.com/CiscoCXSecurity/enum4linux)                                                                                   | A tool for enumerating information from Windows and Samba systems.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| [enum4linux-ng](https://github.com/cddmp/enum4linux-ng)                                                                                       | A rework of the original Enum4linux tool that works a bit differently.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| [ldapsearch](https://linux.die.net/man/1/ldapsearch)                                                                                          | Built-in interface for interacting with the LDAP protocol.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| [windapsearch](https://github.com/ropnop/windapsearch)                                                                                        | A Python script used to enumerate AD users, groups, and computers using LDAP queries. Useful for automating custom LDAP queries.                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| [DomainPasswordSpray.ps1](https://github.com/dafthack/DomainPasswordSpray)                                                                    | DomainPasswordSpray is a tool written in PowerShell to perform a password spray attack against users of a domain.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| [LAPSToolkit](https://github.com/leoloobeek/LAPSToolkit)                                                                                      | The toolkit includes functions written in PowerShell that leverage PowerView to audit and attack Active Directory environments that have deployed Microsoft's Local Administrator Password Solution (LAPS).                                                                                                                                                                                                                                                                                                                                                                                              |
| [smbmap](https://github.com/ShawnDEvans/smbmap)                                                                                               | SMB share enumeration across a domain.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| [psexec.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/psexec.py)                                                        | Part of the Impacket toolkit, it provides us with Psexec-like functionality in the form of a semi-interactive shell.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| [wmiexec.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py)                                                      | Part of the Impacket toolkit, it provides the capability of command execution over WMI.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| [Snaffler](https://github.com/SnaffCon/Snaffler)                                                                                              | Useful for finding information (such as credentials) in Active Directory on computers with accessible file shares.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| [smbserver.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbserver.py)                                                  | Simple SMB server execution for interaction with Windows hosts. Easy way to transfer files within a network.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| [setspn.exe](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc731241(v=ws.11))             | Adds, reads, modifies and deletes the Service Principal Names (SPN) directory property for an Active Directory service account.                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| [Mimikatz](https://github.com/ParrotSec/mimikatz)                                                                                             | Performs many functions. Notably, pass-the-hash attacks, extracting plaintext passwords, and Kerberos ticket extraction from memory on a host.                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| [secretsdump.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py)                                              | Remotely dump SAM and LSA secrets from a host.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| [evil-winrm](https://github.com/Hackplayers/evil-winrm)                                                                                       | Provides us with an interactive shell on a host over the WinRM protocol.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| [mssqlclient.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/mssqlclient.py)                                              | Part of the Impacket toolkit, it provides the ability to interact with MSSQL databases.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| [noPac.py](https://github.com/Ridter/noPac)                                                                                                   | Exploit combo using CVE-2021-42278 and CVE-2021-42287 to impersonate DA from standard domain user.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| [rpcdump.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/rpcdump.py)                                                      | Part of the Impacket toolset, RPC endpoint mapper.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| [CVE-2021-1675.py](https://github.com/cube0x0/CVE-2021-1675/blob/main/CVE-2021-1675.py)                                                       | Printnightmare PoC in python.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| [ntlmrelayx.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py)                                                | Part of the Impacket toolset, it performs SMB relay attacks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| [PetitPotam.py](https://github.com/topotam/PetitPotam)                                                                                        | PoC tool for CVE-2021-36942 to coerce Windows hosts to authenticate to other machines via MS-EFSRPC EfsRpcOpenFileRaw or other functions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| [gettgtpkinit.py](https://github.com/dirkjanm/PKINITtools/blob/master/gettgtpkinit.py)                                                        | Tool for manipulating certificates and TGTs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| [getnthash.py](https://github.com/dirkjanm/PKINITtools/blob/master/getnthash.py)                                                              | This tool will use an existing TGT to request a PAC for the current user using U2U.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| [adidnsdump](https://github.com/dirkjanm/adidnsdump)                                                                                          | A tool for enumerating and dumping DNS records from a domain. Similar to performing a DNS Zone transfer.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| [gpp-decrypt](https://github.com/t0thkr1s/gpp-decrypt)                                                                                        | Extracts usernames and passwords from Group Policy preferences files.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| [GetNPUsers.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetNPUsers.py)                                                | Part of the Impacket toolkit. Used to perform the ASREPRoasting attack to list and obtain AS-REP hashes for users with the 'Do not require Kerberos preauthentication' set. These hashes are then fed into a tool such as Hashcat for attempts at offline password cracking.                                                                                                                                                                                                                                                                                                                             |
| [lookupsid.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/lookupsid.py)                                                  | SID bruteforcing tool.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| [ticketer.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ticketer.py)                                                    | A tool for creation and customization of TGT/TGS tickets. It can be used for Golden Ticket creation, child to parent trust attacks, etc.                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| [raiseChild.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/raiseChild.py)                                                | Part of the Impacket toolkit, It is a tool for automated child to parent domain privilege escalation.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| [Active Directory Explorer](https://docs.microsoft.com/en-us/sysinternals/downloads/adexplorer)                                               | Active Directory Explorer (AD Explorer) is an AD viewer and editor. It can be used to navigate an AD database and view object properties and attributes. It can also be used to save a snapshot of an AD database for offline analysis. When an AD snapshot is loaded, it can be explored as a live version of the database. It can also be used to compare two AD database snapshots to see changes in objects, attributes, and security permissions.                                                                                                                                                   |
| [PingCastle](https://www.pingcastle.com/documentation/)                                                                                       | Used for auditing the security level of an AD environment based on a risk assessment and maturity framework (based on [CMMI](https://en.wikipedia.org/wiki/Capability_Maturity_Model_Integration) adapted to AD security).                                                                                                                                                                                                                                                                                                                                                                               |
| [Group3r](https://github.com/Group3r/Group3r)                                                                                                 | Group3r is useful for auditing and finding security misconfigurations in AD Group Policy Objects (GPO).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| [ADRecon](https://github.com/adrecon/ADRecon)                                                                                                 | A tool used to extract various data from a target AD environment. The data can be output in Microsoft Excel format with summary views and analysis to assist with analysis and paint a picture of the environment's overall security state.                                                                                                                                                                                                                                                                                                                                                              |
# Enumeration
### External Recon
When starting our external recon, we should be looking for a few key things:

| Data                | Items                                                                       |
| ------------------- | --------------------------------------------------------------------------- |
| Network Information | Valid ASNs, netblocks, cloud presence, DNS entries, hosting providers, etc. |
| Domain Information  | Domains, subdomains, services, and possible defenses.                       |
| Schema Format       | Formats of accounts, valid usernames, etc.                                  |
| Data Discolsure     | Publicly accessible files, credentials in these files (such as on GitHub).  |
| Breach Data         | Any publicly released data, including usernames, passwords, and other info. |
Search locations:

| Resource                    | Locations                                                                                                                                                                                                                                                                                         |
| --------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ASN and IP registrars       | [`IANA`](https://www.iana.org/), [`arin`](https://www.arin.net/), [`HE`](https://bgp.he.net/) for Americas, [`RIPE`](https://www.ripe.net/) for Europe.                                                                                                                                           |
| Domain registrars and DNS   | [`Domaintools`](https://www.domaintools.com/), [`PTRArchive`](http://ptrarchive.com/), [`ICANN`](https://lookup.icann.org/lookup) and manual DNS record requests.                                                                                                                                 |
| Social Media                | Self explanatory.                                                                                                                                                                                                                                                                                 |
| Company Websites            | Also self explanatory, focus on "About Us" and "Contact Us" pages though                                                                                                                                                                                                                          |
| Cloud and Developer Storage | GitHub, AWS S3, Azure storage, [Google searches using "Dorks"](https://www.exploit-db.com/google-hacking-database). [`Trufflehog`](https://github.com/trufflesecurity/truffleHog) and sites like [`Greyhat Warfare`](https://buckets.grayhatwarfare.com/) can be used to find leaked credentials. |
| Breaches                    | [`HaveIBeenPwned`](https://haveibeenpwned.com/) to check if any accounts appear in breach data, [`Dehashed`](https://www.dehashed.com/) to search for corporate emails with cleartext passwords or hashes                                                                                         |
Here's a useful [tool](https://github.com/initstring/linkedin2username) for creating false emails using `LinkedIn` data.
### Internal Enumeration
This section should be largely familiar. See [[Network Enumeration with Nmap]] to get started. Here's some additional tools though:
- [`Fping`](https://fping.org/) for ping scanning
- [`Kerbrute`](https://github.com/ropnop/kerbrute) since Kerberos authentication failures usually don't trigger logs or alerts. 
	- Use [this](https://github.com/insidetrust/statistically-likely-usernames) wordlist for potential usernames.
- [`Responder`](https://github.com/lgandx/Responder-Windows) to listen, analyze, and poison `LLMNR`, `NBT-NS`, and `MDNS` requests and responses.
- `TCPDump` and `Wireshark` for a more passive way to find hosts
# Initial Foothold
### LLMNR/NBT-NS Poisoning
LLMNR and NBT-NS are Microsoft backups for when DNS fails. LLMNR is used first, based on the DNS format allowing hosts on the same local link to perform name resolution, and uses `UDP/5355`. A machine will ask all others on the network for the correct host address via LLMNR. When LLMNR fails, NetBIOS Name Service is used over `UDP/137`. 

Here's the general overview of how poisoning works:
1. Host attempts to connect to server, but makes a typo in the address
2. DNS server responds, stating host unknown
3. Host then asks over LLMNR if anyone knows the location of the (incorrectly typed) server address
4. Attacker responds that they have the address
5. Host believes the reply and sends an authentication request to the server with credentials
6. Attacker takes credentials and uses them

**Starting a Poisoning Attack on Linux**
```shell 
sudo responder -I <interface>
```
Once we're able to grab hashes, we can crack using `hashcat`. See [[Password Attacks]]. For quick reference, here's how we can do a `NTMLv2` hash:
```shell
hashcat -m 5600 <hash file> <wordlist>
```
**Poisoning on Windows**
Outdated method:
```PowerShell
Import-Module .\Inveigh.ps1
(Get-Command Invoke-Inveigh).Parameters # Print options
Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Current method (same tool, author just moved to C#):
```PowerShell
.\Inveigh.exe
```
From here, press `ESC` to enter and exit the interactive console. Type `HELP` to see commands and access hashes.
### Password Spraying
Password spraying should be done sparingly in order to prevent mass account lockout. In order to do it effectively, we should follow a few steps:
1. Enumerate enough to understand the username structure and potential password policy of our target
2. Create a target user list based on this enumeration
3. Spray lightly using our lists
##### Finding a Password Policy
With valid domain credentials, finding a password policy is pretty easy. Here's how we can do it remotely:
```shell
crackmapexec smb <IP> -u <user> -p <pass> --pass-pol
```
But this isn't really the point of this section. Instead we want to know how to find a policy without credentials. This can be done through SMB NULL sessions or LDAP anonymous bind.

Here's some ways we can do SMB Null sessions:

Using [`rpcclient`](https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html) on Linux:
```shell
rpcclient -U "" -N <IP>
querydominfo # get domain information
getdompwinfo # get password policy
```
Use [enum4linux-ng](https://github.com/cddmp/enum4linux-ng), it's a rewrite of the original with a few extra features:
```shell
enum4linux -P <IP> # deprecated
enum4linux-ng -P <IP> -oA <Output file> 
```

Our next option is LDAP anonymous binds, which allows unauthenticated users to retrieve information about a domain. It's been deprecated as of Windows server 2003.

On Linux, we can use [`ldapsearch`](https://linux.die.net/man/1/ldapsearch): 
```shell
ldapsearch -h <IP> -x -b "DC=<Domain Controller>,DC=LOCAL" -s sub "*" | grep -m 1 -B 10 pwdHistoryLength
```

Lastly, enumerating from Windows is rare but here's a few commands to do so:
```powershell
# SMB Null
net use \\host\ipc$ "" /u:""
# We can also try using a guest account:
net use \\DC01\ipc$ "password" /u:guest

# Simple commands to display net information
net accounts

# Powershell script
import-module .\PowerView.ps1
Get-DomainPolicy
```


---
Navigation: [[Pentesting]]